---
title: 'æ·±å…¥ Piniaï¼šä»ä»£ç å‡ºå‘æ¢ç´¢ Vue çŠ¶æ€ç®¡ç†çš„å¥¥ç§˜'
date: '2023-04-14'
tags: [FE', 'Pinia', 'VUE']
draft: false
summary: 'æ·±å…¥ Pinia æºç ï¼Œæ¢ç©¶åº•å±‚å®ç°æ–¹å¼ã€‚'
images: ['/static/images/blog/202304/Pinia_source_code/tips.webp']
authors: ['default']
---

# ä¸€ã€ ğŸï¸åˆ›å»ºæºç åˆ†æç¯å¢ƒ

<aside>
ğŸ é¡¹ç›®åœ°å€ï¼š[https://github.com/mk965/read-pinia](https://github.com/mk965/read-pinia)

</aside>

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_1](https://github.com/mk965/read-pinia/tree/article_1)

</aside>

## 1. åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®

```bash
npm init vue@latest
# or
yarn create vite
```

## 2. Pinia æºç å…¥å£

ğŸš—æºç åœ°å€ï¼š [`github.com/vuejs/pinia`](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia)

ğŸ“¦æ‰“åŒ…æ–‡ä»¶ï¼š `rollup.config.js`

ğŸšªå…¥å£æ–‡ä»¶ï¼š `packages/pinia/src/index.ts`

## 3. å¤åˆ¶ Pinia æºç  & åœ¨ `main.ts` ä¸­åˆå§‹åŒ– Pinia æ’ä»¶

å°† `pinia/packages/pinia/src` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°æˆ‘ä»¬ä¹‹å‰ç”Ÿæˆé¡¹ç›®çš„`/src/pinia` ä¸­ã€‚

åœ¨ `main.ts` ä¸­å®‰è£…åˆå§‹åŒ– Piniaï¼š

![pinia](/static/images/blog/202304/Pinia_source_code/img0.webp)

## 4. æ·»åŠ å¿…è¦ä»“åº“ä¾èµ–

æ­¤æ—¶é€šè¿‡ `yarn dev` å¯åŠ¨é¡¹ç›®æ—¶ï¼Œä¼šæŠ¥ç¼ºå°‘ä¾èµ–ã€‚

åœ¨ `rollup.config.js` ç¬¬122è¡Œï¼Œå¯ä»¥çœ‹åˆ°ä¾èµ–åˆ†åˆ«æœ‰

- `vue-demi`ï¼šä¸€ä¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼€å‘åœ¨vue2ã€vue3ä¸Šé€šç”¨çš„ vue åº“çš„å¼€å‘å·¥å…·ã€‚
- `vue`ï¼švue é¡¹ç›®ã€‚
- `@vue/composition-api`ï¼švue ç»„åˆå¼ api æ’ä»¶ã€‚

```tsx showLineNumbers
121 ï½œ const external = ['vue-demi', 'vue', '@vue/composition-api']
```

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­å®‰è£…å¥½è¿™ä¸¤ä¸ªåº“ï¼ˆvue åœ¨åˆ›å»ºé¡¹ç›®æ—¶å·²ç»å®‰è£…äº†ï¼‰ã€‚

```bash
yarn add vue-demi @vue/composition-api
```

## 5. æ·»åŠ å¿…è¦ç¯å¢ƒå˜é‡

æ­¤æ—¶é€šè¿‡ `yarn dev` å¯åŠ¨é¡¹ç›®æ—¶ï¼Œä¼šæŠ¥é¥®ç”¨é”™è¯¯ã€‚

```bash
Uncaught ReferenceError: __DEV__ is not defined
    at rootStore.ts:97:3
```

ç¯å¢ƒå˜é‡ä½äº `rollup.config.js` ç¬¬167è¡Œï¼š

```tsx showLineNumbers
const replacements = {
  __COMMIT__: `"${process.env.COMMIT}"`,
  __VERSION__: `"${pkg.version}"`,
  __DEV__:
    (isBundlerESMBuild && !isRawESMBuild) || (isNodeBuild && !isProduction)
      ? // preserve to be handled by bundlers
        `(process.env.NODE_ENV !== 'production')`
      : // hard coded dev/prod builds
        JSON.stringify(!isProduction),
  // this is only used during tests
  __TEST__:
    (isBundlerESMBuild && !isRawESMBuild) || isNodeBuild
      ? `(process.env.NODE_ENV === 'test')`
      : 'false',
  __FEATURE_PROD_DEVTOOLS__: isBundlerESMBuild
    ? `(typeof __VUE_PROD_DEVTOOLS__ !== 'undefined' && __VUE_PROD_DEVTOOLS__)`
    : 'false',
  // If the build is expected to run directly in the browser (global / esm builds)
  __BROWSER__: JSON.stringify(isRawESMBuild),
  // is targeting bundlers?
  __BUNDLER__: JSON.stringify(isBundlerESMBuild),
  __GLOBAL__: JSON.stringify(isGlobalBuild),
  // is targeting Node (SSR)?
  __NODE_JS__: JSON.stringify(isNodeBuild),
}
```

æˆ‘ä»¬åœ¨ `vite.config.ts` ä¸­æ·»åŠ ç¼ºå°‘çš„ç¯å¢ƒå˜é‡ï¼š

```tsx showLineNumbers
export default defineConfig({
  plugins: [vue()],
  define: {
    __DEV__: true,
    __TEST__: true,
  },
})
```

## 6. ç¯å¢ƒæµ‹è¯•

åœ¨ `src/pinia/createPinia.ts` ä¸­è¾“å‡ºå­—ç¬¦ä¸²ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æ­£å¸¸æ‰“å°ï¼Œå¦‚æ­£å¸¸æ‰“å°åˆ™æºç åˆ†æç¯å¢ƒæ­£å¸¸è¿è¡Œï¼š

![pinia](/static/images/blog/202304/Pinia_source_code/img1.webp)

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_1](https://github.com/mk965/read-pinia/tree/article_1)

</aside>

---

# äºŒã€ğŸ§æºç åˆ†æï¼ˆ1ï¼‰â€”â€”æ‰§è¡Œæµç¨‹

åœ¨ `defineStore`ã€ `createPinia`ã€ `useStore` ç­‰å…³é”®å‡½æ•°å†…æ‰“å°æ—¥å¿—æ¥ç¡®å®šæ‰§è¡Œé¡ºåºï¼š

![pinia](/static/images/blog/202304/Pinia_source_code/img2.webp)

å¯ä»¥ç¡®å®šæ‰§è¡Œé¡ºåºä¸ºï¼š

```
defineStore() â‡’ main.ts â‡’ createPinia() â‡’ useStore()
```

å…¶ä¸­ `defineStore()` æ˜¯åœ¨å¼•ç”¨é˜¶æ®µè¢«è°ƒç”¨ï¼Œå¹¶è¿”å› `useStore()` å‡½æ•°ï¼Œä¹‹åä¾¿å¼€å§‹ Vue çš„æµç¨‹ã€‚æ³¨å†Œæ’ä»¶ç­‰ï¼Œæœ€ååœ¨é¡µé¢å†…è°ƒç”¨ `useStore()`ï¼Œåˆ›å»º Store ç­‰æ­¥éª¤ã€‚

---

# ä¸‰ã€ğŸ§æºç åˆ†æï¼ˆ2ï¼‰â€”â€”createPinia

ä½¿ç”¨ Pinia å‰éœ€è¦åœ¨ vue ä¸­åˆå§‹åŒ–ä¸€ä¸ªæ³¨å†Œ Piniaï¼Œæ³¨å†Œçš„æ–¹æ³•æ˜¯ä½¿ç”¨ ï¼š

```tsx showLineNumbers
import { createPinia } from 'pinia'
app.use(createPinia())
```

æ˜¾ç„¶ `createPinia` å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª [vueæ’ä»¶](https://cn.vuejs.org/guide/reusability/plugins.html#plugins) ã€‚é€šè¿‡æ’ä»¶çš„æ–¹å¼å®‰è£…åˆ° vue ä¸­ã€‚

## 1. æºç ç›®å½•

åœ¨ `src/pinia/index.ts` ç›®å½•ä¸­å¯ä»¥æ‰¾åˆ°ï¼š

```tsx showLineNumbers
export { createPinia } from './createPinia'
```

æ˜¾ç„¶ createPinia å‡½æ•°çš„æºç ç›®å½•ä¸ºï¼š `src/pinia/createPinia.ts` ã€‚

## 2. createPinia

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_2](https://github.com/mk965/read-pinia/tree/article_2)

</aside>

åœ¨å‡½æ•°çš„æœ€å¼€å§‹ï¼Œé€šè¿‡ `effectScope` å£°æ˜äº†ä¸€ä¸ª `ref`ï¼Œå¹¶èµ‹å€¼ç»™äº†**state**ï¼Œæˆ‘ä»¬å°†å…¶ **ç®€å•ç†è§£ä¸ºå£°æ˜äº†ä¸€ä¸ª ref å¹¶èµ‹å€¼ç»™ state** ã€‚

<aside>
ğŸ’¡ **effectScope**
åˆ›å»ºä¸€ä¸ª effect ä½œç”¨åŸŸï¼Œå¯ä»¥æ•è·å…¶ä¸­æ‰€åˆ›å»ºçš„å“åº”å¼å‰¯ä½œç”¨ (å³è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨)ï¼Œè¿™æ ·æ•è·åˆ°çš„å‰¯ä½œç”¨å¯ä»¥ä¸€èµ·å¤„ç†ã€‚å¯¹äºè¯¥ API çš„ä½¿ç”¨ç»†èŠ‚ï¼Œè¯·æŸ¥é˜…å¯¹åº”çš„Â **[RFC](https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md)**ã€‚

</aside>

```tsx showLineNumbers
import { Pinia, PiniaPlugin, setActivePinia, piniaSymbol } from './rootStore'
import { ref, App, markRaw, effectScope, isVue2, Ref } from 'vue-demi'
import { registerPiniaDevtools, devtoolsPlugin } from './devtools'
import { USE_DEVTOOLS } from './env'
import { StateTree, StoreGeneric } from './types'

/**
 * åˆ›å»ºåº”ç”¨ç¨‹åºè¦ä½¿ç”¨çš„Piniaå®ä¾‹
 */
export function createPinia(): Pinia {
  console.log('ğŸ createPinia run!')
  /**
   * effectScope:
   * åˆ›å»ºä¸€ä¸ª effect ä½œç”¨åŸŸï¼Œå¯ä»¥æ•è·å…¶ä¸­æ‰€åˆ›å»ºçš„å“åº”å¼å‰¯ä½œç”¨ (å³è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨)ï¼Œè¿™æ ·æ•è·åˆ°çš„å‰¯ä½œç”¨å¯ä»¥ä¸€èµ·å¤„ç†ã€‚å¯¹äºè¯¥ API çš„ä½¿ç”¨ç»†èŠ‚ï¼Œè¯·æŸ¥é˜…å¯¹åº”çš„ RFCã€‚
   */
  const scope = effectScope(true)
  // NOTE: åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥çª—å£å¯¹è±¡çš„çŠ¶æ€ï¼Œå¹¶ç›´æ¥è®¾ç½®å®ƒ
  // å¦‚æœæœ‰ç±»ä¼¼Vue 3 SSRçš„ä¸œè¥¿
  const state = scope.run<Ref<Record<string, StateTree>>>(() => ref<Record<string, StateTree>>({}))!

  // æ‰€æœ‰éœ€è¦å®‰è£…çš„æ’ä»¶
  let _p: Pinia['_p'] = []
  // åœ¨è°ƒç”¨ app.use(pinia) å‰éœ€è¦å®‰è£…çš„æ’ä»¶
  let toBeInstalled: PiniaPlugin[] = []

  // ä½¿ç”¨ markRaw åŒ…è£¹çš„ pinia ä½¿å…¶ä¸ä¼šå˜ä¸ºå“åº”å¼
  const pinia: Pinia = markRaw({
    // app.use æ‰§è¡Œçš„é€»è¾‘
    install(app: App) {
      // è®¾ç½®å½“å‰ä½¿ç”¨çš„ pinia å®ä¾‹
      setActivePinia(pinia)
      // å¦‚æœæ˜¯ vue2 ï¼Œå…¨å±€æ³¨å†Œå·²ç»åœ¨ PiniaVuePlugin å®Œæˆï¼Œæ‰€ä»¥è¿™æ®µé€»è¾‘å°†è·³è¿‡
      if (!isVue2) {
        // app å®ä¾‹
        pinia._a = app
        // é€šè¿‡ provide ä¼ é€’ pinia å®ä¾‹ï¼Œæä¾›ç»™åç»­ä½¿ç”¨
        app.provide(piniaSymbol, pinia)
        // è®¾ç½®å…¨å±€å±æ€§ $pinia
        app.config.globalProperties.$pinia = pinia
        /* istanbul ignore else */
        if (USE_DEVTOOLS) {
          registerPiniaDevtools(app, pinia)
        }
        // å¤„ç†æœªæ‰§è¡Œæ’ä»¶
        toBeInstalled.forEach((plugin) => _p.push(plugin))
        // å¤„ç†å®Œæ’ä»¶åæ¸…ç©º
        toBeInstalled = []
      }
    },

    /**
     * ä¸º Pinia æä¾›å®‰è£…æ’ä»¶çš„èƒ½åŠ›
     * @param plugin
     * @returns Pinia
     */
    use(plugin) {
      // å¦‚æœ use é˜¶æ®µåˆå§‹åŒ–å®Œæˆåˆ™æš‚å­˜ toBeInstalled ä¸­
      if (!this._a && !isVue2) {
        toBeInstalled.push(plugin)
      } else {
        _p.push(plugin)
      }
      return this
    },

    _p, // æ‰€æœ‰çš„ pinia æ’ä»¶
    // it's actually undefined here
    // @ts-expect-error
    _a: null, // vue å®ä¾‹ï¼Œåœ¨ install é˜¶æ®µè®¾ç½®
    _e: scope, // pinia çš„ä½œç”¨åŸŸå¯¹è±¡ï¼Œæ¯ä¸ª store éƒ½æœ‰å•ç‹¬çš„ scope
    _s: new Map<string, StoreGeneric>(), // store ç¼“å­˜ï¼Œkey ä¸º pinia çš„ idï¼Œvalue ä¸º pinia å¯¹å¤–æš´æ¼çš„æ•°æ®
    state, // pinia æ‰€æœ‰çš„ state çš„åˆé›†ï¼Œkey ä¸º pinia çš„ idï¼Œvalue ä¸º store ä¸‹æ‰€æœ‰çš„ state
  })

  // pinia devtools rely on dev only features so they cannot be forced unless
  // piniaå¼€å‘å·¥å…·ä¾èµ–äºä»…ç”¨äºå¼€å‘çš„åŠŸèƒ½ï¼Œå› æ­¤é™¤é
  // the dev build of Vue is used. Avoid old browsers like IE11.
  // ä½¿ç”¨Vueçš„å¼€å‘ç‰ˆæœ¬ã€‚é¿å…ä½¿ç”¨åƒIE11è¿™æ ·çš„æ—§æµè§ˆå™¨ã€‚
  if (USE_DEVTOOLS && typeof Proxy !== 'undefined') {
    pinia.use(devtoolsPlugin)
  }

  return pinia
}
```

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_2](https://github.com/mk965/read-pinia/tree/article_2)

</aside>

---

# å››ã€ğŸ§æºç åˆ†æï¼ˆ3ï¼‰â€”â€”defineStore

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_3](https://github.com/mk965/read-pinia/tree/article_3)

</aside>

## 1. ä¸‰ç§åˆ›å»ºæ–¹å¼

`defineStore` æ‰€åœ¨ä½ç½®ï¼š `src/pinia/store.ts` è¿›å…¥æ–‡ä»¶ä¹‹åå¯ä»¥çœ‹åˆ°é€šè¿‡å‡½æ•°é‡è½½çš„æ–¹å¼æä¾›ç»™æˆ‘ä»¬ä¸‰ç§å‚æ•°ä¼ é€’æ–¹å¼ï¼š

![pinia](/static/images/blog/202304/Pinia_source_code/img3.webp)

å…¶ä¸­å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š

- `id`ï¼šstore çš„ idï¼Œå¿…é¡»å”¯ä¸€ã€‚
- `options`ï¼š ä¸ Vue çš„é€‰é¡¹å¼ API ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¸¦æœ‰ `id`ã€Â `state`ã€`actions`ä¸Â `getters`å±æ€§çš„ Option å¯¹è±¡ã€‚
- `storeSetup`ï¼šä»¥ `setup` çš„æ–¹å¼åˆ›å»ºï¼Œä¸ Vue çš„ **setup å‡½æ•°** ç›¸ä¼¼ã€‚åœ¨ storeSetup ä¸­ï¼š
  - `ref()` ç­‰åŒäº `state`ã€‚
  - `computed()` ç­‰åŒäº `getters`ã€‚
  - `function()` ç­‰åŒäº `actions`ã€‚

## 2. defineStore çš„æ‰§è¡Œé€»è¾‘

åœ¨ `defineStore` å‡½æ•°ä¸­ï¼Œå¹¶æ²¡æœ‰å¾ˆç‰¹åˆ«çš„é€»è¾‘ï¼Œé¦–å…ˆæ˜¯å¯¹ä¸‰ç§åˆ›å»ºæ–¹å¼è¿›è¡Œå…¼å®¹ï¼Œç„¶åå®šä¹‰ä¸€ä¸ªåä¸º `useStore` çš„å‡½æ•°ï¼Œç„¶åè¿”å› `useStore`ã€‚

`useStore` å…·ä½“åšäº†ä»€ä¹ˆä¸‹èŠ‚åˆ†æã€‚

```tsx showLineNumbers
export function defineStore(
  // TODO: add proper types from above
  idOrOptions: any,
  setup?: any,
  setupOptions?: any
): StoreDefinition {
  let id: string
  let options:
    | DefineStoreOptions<string, StateTree, _GettersTree<StateTree>, _ActionsTree>
    | DefineSetupStoreOptions<string, StateTree, _GettersTree<StateTree>, _ActionsTree>

  // æ­¤å¤„å¯¹ä¸‰ç§åˆ›å»ºæ–¹å¼è¿›è¡Œå…¼å®¹å¤„ç†
  const isSetupStore = typeof setup === 'function'
  if (typeof idOrOptions === 'string') {
    id = idOrOptions
    // the option store setup will contain the actual options in this case
    options = isSetupStore ? setupOptions : setup
  } else {
    options = idOrOptions
    id = idOrOptions.id
  }

  // useStore
  function useStore(pinia?: Pinia | null, hot?: StoreGeneric): StoreGeneric {
    // ...
  }

  useStore.$id = id

  // å°† useStore å‡½æ•°è¿”å›å‡ºå»ï¼Œä½†ä¸ä¼šç«‹å³è°ƒç”¨ï¼Œåœ¨ç»„ä»¶å†…ä½¿ç”¨ store æ—¶æ‰ä¼šè°ƒç”¨ã€‚
  // æ‰€ä»¥åœ¨ defineStore ä¸­åªæ˜¯åšäº†äº›å…¼å®¹é€»è¾‘ï¼Œç„¶åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›çš„è¿™ä¸ªå‡½æ•°çœŸæ­£è°ƒç”¨æ—¶æ‰ä¼šè§¦å‘æ›´å¤šé€»è¾‘ã€‚
  return useStore
}
```

è™½ç„¶æˆ‘ä»¬å‰é¢å®šä¹‰äº†ä¸€ä¸ª storeï¼Œä½†åœ¨æˆ‘ä»¬ä½¿ç”¨Â `<script setup>`Â è°ƒç”¨Â `useStore()` (æˆ–è€…ä½¿ç”¨Â `setup()`Â å‡½æ•°ï¼Œ**åƒæ‰€æœ‰çš„ç»„ä»¶é‚£æ ·**) ä¹‹å‰ï¼Œstore å®ä¾‹æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ã€‚

```tsx showLineNumbers
<script setup>
  import {useMainStore1} from '@/stores/counter' // å¯ä»¥åœ¨ç»„ä»¶ä¸­çš„ä»»æ„ä½ç½®è®¿é—® `store` å˜é‡ âœ¨ const
  store = useMainStore1();
</script>
```

## 4. useStore

åœ¨ä¹‹å‰æˆ‘ä»¬åˆ†æäº† `defineStore` æ–¹æ³•è°ƒç”¨çš„æ—¶å€™è¿”å›äº† `useStore` æ–¹æ³•ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ­¤æ–¹æ³•ç©¶ç«Ÿå¹²äº†äº›ä»€ä¹ˆã€‚

```tsx showLineNumbers
function useStore(pinia?: Pinia | null, hot?: StoreGeneric): StoreGeneric {
  Log('useStore()')

  // è·å–å½“å‰ vue å®ä¾‹
  const currentInstance = getCurrentInstance()
  pinia =
    // åœ¨ test æ¨¡å¼ä¸‹ï¼Œå¿½ç•¥æä¾›çš„å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ€»æ˜¯å¯ä»¥é€šè¿‡ getActivePinia() è·å– pinia å®ä¾‹
    // å¦‚æœ æ˜¯testæ¨¡å¼ && activePiniaä¸ä¸ºç©º && activePiniaæ˜¯testæ¨¡å¼ åˆ™ä¸ºç©º å¦åˆ™ è¿”å›å‚æ•°ä¸­çš„pinia
    // æˆ–è€… å¦‚æœè·å–åˆ°äº†å½“å‰å®ä¾‹ å¹¶ä¸” å­˜åœ¨piniaSymbol è¿”å› inject(piniaSymbol, null) å¦åˆ™ è¿”å›ç©º
    (__TEST__ && activePinia && activePinia._testing ? null : pinia) ||
    // è¿™é‡Œçš„ inject(piniaSymbol) æ˜¯åœ¨ createPinia çš„ install ä¸­ app.provide(piniaSymbol, pinia);
    (currentInstance && inject(piniaSymbol, null))

  console.log('pinia å®ä¾‹ ==>', pinia)

  // å°†å½“å‰ pinia å®ä¾‹è®¾ç½®ä¸ºæ¿€æ´»çš„ pinia
  // å¦‚æœå­˜åœ¨å¤šä¸ª pinia å®ä¾‹ï¼Œæ–¹ä¾¿åç»­é€»è¾‘è·å–å½“å‰piniaå®ä¾‹
  if (pinia) setActivePinia(pinia)

  // åœ¨ devç¯å¢ƒ å¹¶ä¸” è·å–ä¸åˆ°å½“å‰ pinia å®ä¾‹ï¼Œåˆ™è¯´æ˜æœªå…¨å±€æ³¨å†Œï¼ŒæŠ›å‡ºé”™è¯¯
  if (__DEV__ && !activePinia) {
    throw new Error(
      `[ğŸ]: getActivePinia was called with no active Pinia. Did you forget to install pinia?\n` +
        `\tconst pinia = createPinia()\n` +
        `\tapp.use(pinia)\n` +
        `This will fail in production.`
    )
  }

  // å°†æ¿€æ´»çš„ pinia å®ä¾‹èµ‹å€¼ç»™ pinia å˜é‡ï¼Œç¡®ä¿ pinia === activePiniaã€‚é˜²æ­¢ setActivePinia å‡ºé”™å¯¼è‡´ä¸¤ä¸ªå˜é‡ä¸ä¸€è‡´
  pinia = activePinia!

  // å¦‚æœ pinia çš„ store ç¼“å­˜ä¸­æ²¡æœ‰å½“å‰çš„ idï¼Œåˆ™åˆ›å»ºæ–°çš„ storeï¼Œ
  // å¦åˆ™ç›´æ¥è·å–ç¼“å­˜ä¸­ storeã€‚
  if (!pinia._s.has(id)) {
    // åˆ›å»º store å¹¶å°†å…¶æ³¨å†Œåœ¨ pinia._s ä¸­
    if (isSetupStore) {
      // ç»„åˆå¼
      createSetupStore(id, setup, options, pinia)
    } else {
      // é€‰é¡¹å¼
      createOptionsStore(id, options as any, pinia)
    }

    /* istanbul ignore else */
    if (__DEV__) {
      // @ts-expect-error: not the right inferred type
      useStore._pinia = pinia
    }
  }

  // è·å– pinia ç¼“å­˜ä¸­çš„ store
  const store: StoreGeneric = pinia._s.get(id)!

  // å¼€å‘ç¯å¢ƒ å¹¶ä¸” æ˜¯çƒ­æ›´æ–°
  if (__DEV__ && hot) {
    const hotId = '__hot:' + id
    const newStore = isSetupStore
      ? createSetupStore(hotId, setup, options, pinia, true)
      : createOptionsStore(hotId, assign({}, options) as any, pinia, true)

    hot._hotUpdate(newStore)

    // cleanup the state properties and the store from the cache
    delete pinia.state.value[hotId]
    pinia._s.delete(hotId)
  }

  // save stores in instances to access them devtools
  if (
    __DEV__ &&
    IS_CLIENT &&
    currentInstance &&
    currentInstance.proxy &&
    // avoid adding stores that are just built for hot module replacement
    !hot
  ) {
    const vm = currentInstance.proxy
    const cache = '_pStores' in vm ? vm._pStores! : (vm._pStores = {})
    cache[id] = store
  }

  // StoreGeneric cannot be casted towards Store
  return store as any
}
```

ä»ä¸Šè¾¹ä»£ç ä¸­ï¼Œå¯ä»¥å‘ç°æœ€å…³é”®çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ `createSetupStore`ã€ `createOptionsStore`ï¼Œåˆ†åˆ«æ˜¯åˆ›å»º **ç»„åˆå¼Store** å’Œ **é€‰é¡¹å¼Store**ã€‚é‡Œè¾¹åŒ…å«äº†åˆ›å»º store çš„å…³é”®é€»è¾‘ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹ã€‚

## 5. createSetupStore

`createSetupStore` çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªç»„åˆå¼çš„ storeï¼Œä¹‹åçš„ `createOptionsStore` å…¶å®ä¹Ÿæ˜¯æŠŠ `option` è½¬åŒ–åè°ƒç”¨ `createSetupStore` æ¥åˆ›å»º storeã€‚`createSetupStore` çš„æºç å¾ˆé•¿ï¼Œæˆ‘ä»¬åˆ†æ‰¹ç ”ç©¶ã€‚å¯¹äºä¸€äº›å˜é‡çš„å®šä¹‰ç­‰å†…å®¹åœ¨æ­¤çœç•¥ï¼Œåªå…³æ³¨æœ€æ ¸å¿ƒé€»è¾‘ï¼Œè¯¦ç»†çš„æ³¨é‡Šå¯ä»¥æŸ¥çœ‹ [Github](https://github.com/mk965/read-pinia/tree/article_3) ä¸­çš„æºç ã€‚

### (1) å‚æ•°

`createSetupStore` æ€»å…±æ¥æ”¶äº†6ä¸ªå‚æ•°ï¼š

- **$id** ï¼šå½“å‰ Store çš„ IDï¼Œ
- **setup** defineStore æˆ–è€… createOptionsStore ä¼ å…¥çš„ setup å‡½æ•°
- **options** é…ç½®é€‰é¡¹ï¼Œstateã€getterã€actions ç­‰
- **pinia** Pinia å®ä¾‹
- **hot** çƒ­æ›´æ–°ç›¸å…³
- **isOptionsStore** æ˜¯å¦æ˜¯ é€‰é¡¹å¼ Store åˆ›å»º

```tsx showLineNumbers
/**
 * åˆ›å»ºç»„åˆå¼ Store
 * @param $id Store ID
 * @param setup defineStore ä¼ å…¥çš„ setup å‡½æ•°
 * @param options é…ç½®é€‰é¡¹
 * @param pinia Pinia å®ä¾‹
 * @param hot çƒ­æ›´æ–°ç›¸å…³
 * @param isOptionsStore æ˜¯å¦æ˜¯ é€‰é¡¹å¼ Store åˆ›å»º
 * @returns åˆ›å»ºçš„ store
 */
function createSetupStore<
  Id extends string,
  SS extends Record<any, unknown>,
  S extends StateTree,
  G extends Record<string, _Method>,
  A extends _ActionsTree,
>(
  $id: Id,
  setup: () => SS,
  options: DefineSetupStoreOptions<Id, S, G, A> | DefineStoreOptions<Id, S, G, A> = {},
  pinia: Pinia,
  hot?: boolean,
  isOptionsStore?: boolean
): Store<Id, S, G, A> {
  // ...

  return store
}
```

### (2) åˆ›å»º Store

æ­¤è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `setupStore` å¸¸é‡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä½œç”¨åŸŸå¹¶æ‰§è¡Œäº† `setup` å‡½æ•°ï¼Œè·å–åˆ° `setup` å‡½æ•°ä¸­è¿”å›çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ stateã€getterã€action ç­‰å†…å®¹ã€‚

åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œstate çš„å†…å®¹ä¹Ÿä¼šè¢«å­˜å‚¨åˆ° `pinia.state` ä¸­ã€‚action åˆ™ä¼šè¢« `wrapAction` å¤„ç†ã€‚

å¯¹æ¯ä¸€é¡¹ action è¿›è¡Œå¤„ç†ï¼Œç›®çš„æ˜¯ä¸ºäº†æ”¯æŒ `$onAction` æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šåœ¨æ‰§è¡Œ action æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å¯ä»¥æ¥æ”¶ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š**è¢«è°ƒç”¨çš„ store**ã€**action çš„åå­—**ã€**ä¼ é€’ç»™ action çš„å‚æ•°**ã€‚åœ¨ store ä¸­è¿˜ä¼šæœ‰ä¸€äº›åŸºç¡€æ“ä½œçš„ API ï¼Œè¯·çœ‹ä¸‹èŠ‚ã€‚

```tsx showLineNumbers
// åœ¨å½“å‰ pinia å®ä¾‹çš„ç¼“å­˜ä¸­æ–°å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œåœ¨ä½œç”¨åŸŸä¸­æ‰§è¡Œ setup å‡½æ•°
// æ‰§è¡Œçš„ç»“æœä¸º store ã€‚ example: { count: ObjectRefImpl, increment: Function () }
const setupStore = pinia._e.run(() => {
  scope = effectScope()
  return scope.run(() => setup())
})!

// è¦†ç›–ç°æœ‰æ“ä½œä»¥æ”¯æŒ $onAction
for (const key in setupStore) {
  const prop = setupStore[key]

  // ((å¦‚æœæ˜¯ ref) å¹¶ä¸” (ä¸æ˜¯ computed)) æˆ–è€… (æ˜¯ reactive)
  if ((isRef(prop) && !isComputed(prop)) || isReactive(prop)) {
    // å¦‚æœæ˜¯ optionsStore æ–¹å¼åˆ›å»ºï¼Œoption ç»“æ„å·²ç»åœ¨ createOptionsStore å°†å…¶åŠ å…¥ pinia
    if (!isOptionsStore) {
      // å°† ref è½¬ç§»åˆ° pinia state ä»¥ä¿æŒä¸€åˆ‡åŒæ­¥
      if (isVue2) {
        set(pinia.state.value[$id], key, prop)
      } else {
        pinia.state.value[$id][key] = prop
      }
    }
    // å¦åˆ™ï¼Œå¦‚æœæ˜¯å‡½æ•°ç±»å‹ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ª action
  } else if (typeof prop === 'function') {
    // å¦‚æœæ˜¯é‡å†™è¿™ä¸ªå€¼ï¼Œåº”è¯¥é¿å…ä½¿ç”¨ wrapAction é‡å¤åŒ…è£…
    const actionValue = __DEV__ && hot ? prop : wrapAction(key, prop)
    // è¿™æ˜¯ä¸€ä¸ªçƒ­æ›´æ–°æ¨¡å—æ›¿æ¢ storeï¼Œå› ä¸º hotUpdate æ–¹æ³•éœ€è¦åœ¨æ­£ç¡®çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå®ƒ
    if (isVue2) {
      set(setupStore, key, actionValue)
    } else {
      setupStore[key] = actionValue
    }

    // å°† actions å­˜å‚¨åˆ°æ’ä»¶é…ç½®çš„ actions æ•°ç»„ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨æ’ä»¶ä¸­ä½¿ç”¨
    optionsForPlugin.actions[key] = prop
  }
}
```

### (3) åŸºç¡€ API

åœ¨ Pinia çš„ store ä¸­å­˜åœ¨å¾ˆå¤šåŸºç¡€ APIï¼Œæ¯”å¦‚ï¼šè·å– store id `$id`ã€å¢åŠ  action è°ƒç”¨å›è°ƒ `$onAction()`ã€é‡ç½® store `$reset()`ã€å˜æ›´ store `$patch()`ã€è®¢é˜… `$subscribe()`ã€ç§»é™¤ store `$dispose`ã€è·å–æ‰€æœ‰ state `$state` ç­‰ã€‚æˆ‘ä»¬é€ä¸ªåˆ†æã€‚

![pinia](/static/images/blog/202304/Pinia_source_code/img4.webp)

åŸºç¡€çš„ API é¦–å…ˆè¢«å‚¨å­˜åœ¨ `partialStore` ä¸­ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª `store` å¸¸é‡ï¼Œå¹¶ä¸”æŠŠè¿™äº›åŸºç¡€ API å’Œ store çš„å†…å®¹éƒ½åˆå¹¶åˆ° `store` å¸¸é‡ä¸­ã€‚

```tsx showLineNumbers
/**
 * å…·æœ‰ state å’Œ åŠŸèƒ½ çš„åŸºæœ¬ storeï¼Œä½†ä¸èƒ½ç›´æ¥ä½¿ç”¨ã€‚
 */
const partialStore = {
  _p: pinia,
  $id,
  $onAction,
  $patch,
  $reset,
  $subscribe,
  $dispose,
} as _StoreWithState<Id, S, G, A>
```

### (4) Store å’Œ åŸºç¡€ API åˆå¹¶

åœ¨ (2) å’Œ (3) ä¸­æˆ‘ä»¬åˆ›å»ºäº† store çš„åŸºæœ¬å†…å®¹å’ŒåŸºç¡€çš„APIï¼Œç°åœ¨æ–°å»ºä¸€ä¸ªå˜é‡ï¼Œå¹¶æŠŠå®ƒä»¬åˆå¹¶åˆ°ä¸€å—ï¼š

```tsx showLineNumbers
/**
 * åˆ›å»ºä¸€ä¸ªå“åº”å¼çš„ store å¯¹è±¡
 * å°†åŸºç¡€å‡½æ•°åˆå¹¶åˆ° store ä¸­
 */
const store: Store<Id, S, G, A> = reactive(
  __DEV__ || USE_DEVTOOLS
    ? assign(
        {
          _hmrPayload,
          _customProperties: markRaw(new Set<string>()), // devtools custom properties
        },
        partialStore
        // must be added later
        // setupStore
      )
    : partialStore
) as unknown as Store<Id, S, G, A>

assign(toRaw(store), setupStore)
```

ç°åœ¨ï¼Œè¿˜ç¼ºå°‘ä¸€ä¸ªè·å–æ‰€æœ‰ state å¾—å±æ€§ï¼š `$state` ï¼Œæˆ‘ä»¬ä½¿ç”¨ `defineProperty` ç»™ `store` å¢åŠ  `$state` å±æ€§ ï¼š

```tsx showLineNumbers
// ä½¿ç”¨å®ƒè€Œä¸æ˜¯ computed with setter å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åˆ›å»ºå®ƒï¼Œè€Œæ— éœ€å°†è®¡ç®—çš„ç”Ÿå‘½å‘¨æœŸé“¾æ¥åˆ°é¦–æ¬¡åˆ›å»º store çš„ä»»ä½•åœ°æ–¹ã€‚
// ç»™ store å®šä¹‰ $state å±æ€§ï¼Œæ–¹ä¾¿è·å–å…¨éƒ¨çš„ state
Object.defineProperty(store, '$state', {
  get: () => (__DEV__ && hot ? hotState.value : pinia.state.value[$id]),
  set: (state) => {
    /* istanbul ignore if */
    if (__DEV__ && hot) {
      throw new Error('cannot set hotState')
    }
    $patch(($state) => {
      assign($state, state)
    })
  },
})
```

### (5) å¯¹äº Pinia è‡ªå®šä¹‰æ’ä»¶çš„å¤„ç†

åœ¨ä¹‹å‰çš„ `createPinia()` æ–¹æ³•ä¸­ï¼ŒPinia å®ä¾‹ä¸Šå­˜åœ¨ä¸€ä¸ª `use()` æ–¹æ³•æ˜¯å¯¹è‡ªå®šä¹‰æ’ä»¶çš„æ”¯æŒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹å®‰è£…çš„æ’ä»¶è¿›è¡Œå¤„ç†ï¼Œè°ƒç”¨å·¦å³çš„æ’ä»¶å‡½æ•°ï¼Œå¹¶ç»™å‡½æ•°ä¼ å…¥ `store app piain options` å››ä¸ªå‚æ•°ã€‚

```tsx showLineNumbers
// apply å…¨éƒ¨æ’ä»¶
pinia._p.forEach((extender) => {
  console.log('æ’ä»¶å®‰è£…ï¼š', extender)
  // å¦‚æœä½¿ç”¨å¼€å‘å·¥å…·
  /* istanbul ignore else */
  if (USE_DEVTOOLS) {
    const extensions = scope.run(() =>
      // è°ƒç”¨æ’ä»¶ï¼Œå¹¶ä¼ å…¥å‚æ•°
      extender({
        store,
        app: pinia._a,
        pinia,
        options: optionsForPlugin,
      })
    )!
    Object.keys(extensions || {}).forEach((key) => store._customProperties.add(key))
    assign(store, extensions)
  } else {
    // è¿™é‡Œå°†æ’ä»¶è¿”å›çš„å±æ€§åˆå¹¶åˆ° store ä¸­
    assign(
      store,
      scope.run(() =>
        extender({
          store,
          app: pinia._a,
          pinia,
          options: optionsForPlugin,
        })
      )!
    )
  }
})
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·ç»™ Piain å®‰è£…æ’ä»¶ï¼š

```tsx showLineNumbers
const pinia = createPinia()

// ç»™ pinia å®‰è£…æ’ä»¶
pinia.use((prop) => {
  Log('Pinia æ’ä»¶ä½¿ç”¨')
  console.log('æ’ä»¶è·å–åˆ°çš„å‚æ•°ï¼š', prop)
  return {
    $aaa: (param: string) => {
      console.log('è¿™é‡Œæ˜¯æ’ä»¶å®‰è£…åˆ° Pinia ä¸Šçš„åŠŸèƒ½')
      console.log('prop', prop)
      console.log('param', param)
    },
  }
})

app.use(pinia)
```

ä½¿ç”¨æ’ä»¶ï¼š

```tsx showLineNumbers
store.$aaa('ä¼ é€’çš„å‚æ•°')
```

![pinia](/static/images/blog/202304/Pinia_source_code/img5.webp)

## 6. createOptionsStore

`createOptionsStore` çš„ä»£ç é‡æ¯”è¾ƒå°‘ï¼Œä»ä¸‹é¢çš„ä»£ç å¯ä»¥å‘ç°ï¼ŒåŸºæœ¬çš„é€»è¾‘å°±æ˜¯ä» `options` ä¸­è·å–åˆ° `state`ã€ `actions`ã€ `getters`ï¼Œå®šä¹‰ä¸€ä¸ª `setup` å‡½æ•°å¹¶è°ƒç”¨ `createSetupStore` åˆ›å»º Storeï¼Œè¿˜è¦å°† `getters` è½¬æ¢ä¸º `computed`ã€‚

```tsx showLineNumbers
/**
 * åˆ›å»º é€‰é¡¹å¼ store
 * @param id Store ID
 * @param options é…ç½®é€‰é¡¹
 * @param pinia Pinia å®ä¾‹
 * @param hot çƒ­æ›´æ–°ç›¸å…³
 * @returns åˆ›å»ºçš„ store
 */
function createOptionsStore<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A extends _ActionsTree,
>(
  id: Id,
  options: DefineStoreOptions<Id, S, G, A>,
  pinia: Pinia,
  hot?: boolean
): Store<Id, S, G, A> {
  Log('createOptionsStore()')
  const { state, actions, getters } = options

  const initialState: StateTree | undefined = pinia.state.value[id]

  let store: Store<Id, S, G, A>

  /**
   * è‡ªå®šä¹‰ä¸€ä¸ª setup å‡½æ•°
   * @returns store
   */
  function setup() {
    if (!initialState && (!__DEV__ || !hot)) {
      /* istanbul ignore if */
      if (isVue2) {
        set(pinia.state.value, id, state ? state() : {})
      } else {
        pinia.state.value[id] = state ? state() : {}
      }
    }

    // é¿å…åœ¨ pinia.state.value ä¸­åˆ›å»º state
    const localState =
      __DEV__ && hot
        ? // ä½¿ç”¨ ref() è§£åŒ…çŠ¶æ€ä¸­çš„å¼•ç”¨
          toRefs(ref(state ? state() : {}).value)
        : toRefs(pinia.state.value[id])

    return assign(
      localState,
      actions,
      Object.keys(getters || {}).reduce(
        (computedGetters, name) => {
          if (__DEV__ && name in localState) {
            // getter ä¸èƒ½å’Œ state å±æ€§åŒå
            console.warn(
              `[ğŸ]: A getter cannot have the same name as another state property. Rename one of them. Found with "${name}" in store "${id}".`
            )
          }

          // æŠŠ getter è½¬ä¸º computed
          computedGetters[name] = markRaw(
            computed(() => {
              setActivePinia(pinia)
              // it was created just before
              const store = pinia._s.get(id)!

              // allow cross using stores
              /* istanbul ignore next */
              if (isVue2 && !store._r) return

              // @ts-expect-error
              // return getters![name].call(context, context)
              // TODO: avoid reading the getter while assigning with a global variable
              return getters![name].call(store, store)
            })
          )
          return computedGetters
        },
        {} as Record<string, ComputedRef>
      )
    )
  }

  store = createSetupStore(id, setup, options, pinia, hot, true)

  return store as any
}
```

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_3](https://github.com/mk965/read-pinia/tree/article_3)

</aside>

---

# äº”ã€ğŸ§æºç åˆ†æï¼ˆ4ï¼‰â€”â€” store çš„åŸºç¡€ API å®ç°

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_3](https://github.com/mk965/read-pinia/tree/article_3)

</aside>

## 1. $id

è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯ `createSetupStore` å‚æ•°ä¸­çš„ `$id`ã€‚

## 2. $onAction

è®¾ç½®ä¸€ä¸ªå›è°ƒï¼Œå½“ä¸€ä¸ª action å³å°†è¢«è°ƒç”¨æ—¶ï¼Œå°±ä¼šè¢«è°ƒç”¨ã€‚ å›è°ƒæ¥æ”¶ä¸€ä¸ªå¯¹è±¡ï¼Œ å…¶åŒ…å«è¢«è°ƒç”¨ action çš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼š

- `store`: è¢«è°ƒç”¨çš„ store
- `name`: action çš„åç§°
- `args`: ä¼ é€’ç»™ action çš„å‚æ•°

é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä¼šæ¥æ”¶ä¸¤ä¸ªå‡½æ•°ï¼Œ å…è®¸åœ¨ action å®Œæˆæˆ–å¤±è´¥æ—¶æ‰§è¡Œçš„å›è°ƒã€‚

å®ƒè¿˜ä¼šè¿”å›ä¸€ä¸ªç”¨æ¥åˆ é™¤å›è°ƒçš„å‡½æ•°ã€‚ è¯·æ³¨æ„ï¼Œå½“åœ¨ç»„ä»¶å†…è°ƒç”¨Â `store.$onAction()`Â æ—¶ï¼Œé™¤éÂ `detached`Â è¢«è®¾ç½®ä¸º trueï¼Œ å¦åˆ™å½“ç»„ä»¶è¢«å¸è½½æ—¶ï¼Œå®ƒå°†è¢«è‡ªåŠ¨æ¸…ç†æ‰ã€‚

åœ¨ Pinia çš„æºç ä¸­ï¼Œå…³äº `$onAction` çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```tsx showLineNumbers
const partialStore = {
  // ...
  $onAction: addSubscription.bind(null, actionSubscriptions),
  // ...
}
```

å¯ä»¥å‘ç°ï¼Œ `$onAction` å°±æ˜¯ç»™ `addSubscription` å‡½æ•°ç»‘å®šäº†ä¸ª `null` çš„ `this` å’Œä¸€ä¸ªå‚æ•°ï¼Œå†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª `addSubscription` æ˜¯ä½•æ–¹ç¥åœ£ï¼š

```tsx showLineNumbers
export const noop = () => {}

/**
 * æ·»åŠ è®¢é˜…
 * @param subscriptions è®¢é˜…è€…æ•°ç»„
 * @param callback å›è°ƒ
 * @param detached
 * @param onCleanup å½“æ¸…æ¥šè®¢é˜…æ—¶çš„å›è°ƒ
 * @returns æ¸…é™¤è®¢é˜…çš„å›è°ƒ
 */
export function addSubscription<T extends _Method>(
  subscriptions: T[],
  callback: T,
  detached?: boolean,
  onCleanup: () => void = noop
) {
  subscriptions.push(callback)

  // ç§»é™¤è®¢é˜…
  const removeSubscription = () => {
    const idx = subscriptions.indexOf(callback)
    // å¦‚æœå­˜åœ¨è¿™ä¸ªè®¢é˜…ï¼Œåœ¨è®¢é˜…æ•°ç»„ä¸­ç§»é™¤æ‰ï¼Œå¹¶æ‰§è¡Œå›è°ƒ
    if (idx > -1) {
      subscriptions.splice(idx, 1)
      // æ‰§è¡Œç§»é™¤è®¢é˜…å›è°ƒ
      onCleanup()
    }
  }

  // detached ä¸º true æ—¶ï¼Œåœ¨å½“å‰ä½œç”¨äºåœæ­¢æ—¶ï¼Œä¸ä¼šåˆ é™¤æ­¤è®¢é˜…ï¼Œä¸º false æ—¶ä¼šç§»é™¤æ­¤è®¢é˜…
  // getCurrentScope å¦‚æœæœ‰çš„è¯ï¼Œè¿”å›å½“å‰æ´»è·ƒçš„ effect ä½œç”¨åŸŸ
  if (!detached && getCurrentScope()) {
    // onScopeDispose: åœ¨å½“å‰æ´»è·ƒçš„ effect ä½œç”¨åŸŸä¸Šæ³¨å†Œä¸€ä¸ªå¤„ç†å›è°ƒå‡½æ•°ã€‚å½“ç›¸å…³çš„ effect ä½œç”¨åŸŸåœæ­¢æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚
    onScopeDispose(removeSubscription)
  }

  // è¿”å›ç§»é™¤è®¢é˜…çš„å‡½æ•°
  return removeSubscription
}
```

## 3. $patch

å°†ä¸€ä¸ª state è¡¥ä¸åº”ç”¨äºå½“å‰çŠ¶æ€ã€‚å…è®¸ä¼ é€’åµŒå¥—å€¼ã€‚

`$patch` å…è®¸ä¸¤ç§å‚æ•°ä¼ é€’æ–¹å¼ï¼Œä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œæˆ–ä¸€ä¸ª state çš„è¡¥ä¸ã€‚

```tsx showLineNumbers
/**
 * $patch å‡½æ•°ä¼ é€’æ–¹å¼
 * @param stateMutation
 * @example store.$patch((state) => state.count += 200);
 */
function $patch(stateMutation: (state: UnwrapRef<S>) => void): void
/**
 * $patch å¯¹è±¡ä¼ é€’æ–¹å¼
 * @param partialState
 * @example store.$patch({ count: 100 });
 */
function $patch(partialState: _DeepPartial<UnwrapRef<S>>): void
function $patch(
  partialStateOrMutator: _DeepPartial<UnwrapRef<S>> | ((state: UnwrapRef<S>) => void)
): void {
  Log('$patch', partialStateOrMutator)
  // è®¢é˜…æ”¶é›†å™¨ï¼Œä¿å­˜æ”¶é›†åˆ°çš„è®¢é˜…è€…
  let subscriptionMutation: SubscriptionCallbackMutation<S>
  isListening = isSyncListening = false
  // é‡ç½® debugger äº‹ä»¶ï¼Œå› ä¸º patches æ˜¯åŒæ­¥çš„
  /* istanbul ignore else */
  if (__DEV__) {
    debuggerEvents = []
  }
  // å¯¹ä¸¤ç§ä¼ å‚æ–¹å¼è¿›è¡Œå…¼å®¹
  // å¦‚æœå‚æ•°æ˜¯å‡½æ•°
  if (typeof partialStateOrMutator === 'function') {
    // å¦‚æœæ˜¯å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨ï¼Œå¹¶æŠŠ state ä¼ è¿‡å»
    partialStateOrMutator(pinia.state.value[$id] as UnwrapRef<S>)
    // æ”¶é›†è®¢é˜…ï¼Œåˆ†åˆ«ä¿å­˜ç±»å‹ã€idã€äº‹ä»¶
    subscriptionMutation = {
      type: MutationType.patchFunction,
      storeId: $id,
      events: debuggerEvents as DebuggerEvent[],
    }
  } else {
    // å¦‚æœä¼ æ¥çš„æ˜¯ object
    // merge å‚æ•°å¯¹è±¡åˆ°å½“å‰ store çš„ state
    mergeReactiveObjects(pinia.state.value[$id], partialStateOrMutator)
    subscriptionMutation = {
      type: MutationType.patchObject,
      payload: partialStateOrMutator,
      storeId: $id,
      events: debuggerEvents as DebuggerEvent[],
    }
  }
  //
  const myListenerId = (activeListener = Symbol())
  nextTick().then(() => {
    if (activeListener === myListenerId) {
      isListening = true
    }
  })
  isSyncListening = true
  // åœ¨ä¸Šæ–¹é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å°† isListening isSyncListening é‡ç½®ä¸º falseï¼Œä¸ä¼šè§¦å‘ $subscribe ä¸­çš„ callbackï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›è¡Œè®¢é˜…å‘å¸ƒ
  triggerSubscriptions(subscriptions, subscriptionMutation, pinia.state.value[$id] as UnwrapRef<S>)
}
```

å…¶ä¸­ `triggerSubscriptions` æ–¹æ³•æ˜¯å‘å¸ƒè€…ï¼Œæ‰§è¡Œè®¢é˜…å‡½æ•°çš„å›è°ƒï¼š

```tsx showLineNumbers
/**
 * è§¦å‘è®¢é˜…è€…å›è°ƒ
 * @param subscriptions è®¢é˜…æ•°ç»„
 * @param args ä¼ ç»™å›è°ƒçš„å‚æ•°
 */
export function triggerSubscriptions<T extends _Method>(
  subscriptions: T[],
  ...args: Parameters<T>
) {
  subscriptions.slice().forEach((callback) => {
    callback(...args)
  })
}
```

## 4. $reset

é€šè¿‡å»ºç«‹ä¸€ä¸ªæ–°çš„çŠ¶æ€å¯¹è±¡ï¼Œå°† store é‡è®¾ä¸ºåˆå§‹çŠ¶æ€ã€‚

```tsx showLineNumbers
/**
 * $reset
 * åªæœ‰ é€‰é¡¹å¼ æ„å»ºçš„æ‰å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œ
 * å› ä¸º state: () => ({count: 1}) æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåªè¦é‡æ–°è°ƒç”¨å°±å¯ä»¥è·å–åŸå§‹å€¼ï¼Œ
 * è€Œ ç»„åˆå¼ æ„å»ºçš„è¯ state ä»¥ ref() çš„å½¢å¼å®ç°ï¼Œæ— æ³•è·å–åŸå§‹å€¼ã€‚
 */
const $reset = isOptionsStore
  ? function $reset(this: _StoreWithState<Id, S, G, A>) {
      const { state } = options as DefineStoreOptions<Id, S, G, A>
      // å–å‡º options ä¸­çš„ state å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä»¥è·å–åˆ°åŸå§‹ state
      const newState = state ? state() : {}
      // ä½¿ç”¨ $patch æ›´æ–° stateï¼Œå¹¶åˆ†å‘è®¢é˜…
      this.$patch(($state) => {
        assign($state, newState)
      })
    }
  : /* istanbul ignore next */
    __DEV__
    ? () => {
        // å¦‚æœæ˜¯ç»„åˆå¼è¯­æ³•æ„å»ºçš„è¯ï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸º ref() ä¸èƒ½è·å–åˆ°åŸå§‹å€¼
        throw new Error(
          `ğŸ: Store "${$id}" is built using the setup syntax and does not implement $reset().`
        )
      }
    : // noop æ˜¯ä¸ªç©ºå‡½æ•°ï¼Œç”Ÿäº§ç¯å¢ƒä¸æŠ›å‡ºé”™è¯¯
      noop
```

## 5. $subscribe

è®¾ç½®ä¸€ä¸ªå›è°ƒï¼Œå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¢«è°ƒç”¨ã€‚å®ƒä¼šè¿”å›ä¸€ä¸ªç”¨æ¥ç§»é™¤æ­¤å›è°ƒçš„å‡½æ•°ã€‚ è¯·æ³¨æ„ï¼Œå½“åœ¨ç»„ä»¶å†…è°ƒç”¨Â `store.$subscribe()` æ—¶ï¼Œé™¤éÂ `detached` è¢«è®¾ç½®ä¸º trueï¼Œ å¦åˆ™å½“ç»„ä»¶è¢«å¸è½½æ—¶ï¼Œå®ƒå°†è¢«è‡ªåŠ¨æ¸…ç†æ‰ã€‚

```tsx showLineNumbers
/**
 * å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¢«è°ƒç”¨
 * å®ƒä¼šè¿”å›ä¸€ä¸ªç”¨æ¥ç§»é™¤æ­¤å›è°ƒçš„å‡½æ•°
 * @param callback å›è°ƒ
 * @param options é…ç½®
 * @returns è¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…çš„å‡½æ•°ï¼Œè°ƒç”¨æ¬¡å‡½æ•°æ—¶è®¢é˜…å°±è¢«å–æ¶ˆäº†
 */
function $subscribe(callback, options = {}) {
  Log('$subscribe', options)
  // å–æ¶ˆè®¢é˜…å‡½æ•°
  const removeSubscription = addSubscription(subscriptions, callback, options.detached, () =>
    stopWatcher()
  )
  // effectScopeï¼šåˆ›å»ºä¸€ä¸ª effect ä½œç”¨åŸŸï¼Œå¯ä»¥è¡¥è´§å…¶ä¸­æ‰€åˆ›å»ºçš„å“åº”å¼å‰¯ä½œç”¨ (å³è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨)ï¼Œè¿™é‡Œç”¨äºæ•è· watchï¼Œä»¥ä¾¿äºé”€æ¯storeçš„æ—¶å€™ç»Ÿä¸€å¤„ç†ã€‚
  const stopWatcher = scope.run(() =>
    // ä»è¿™é‡Œå¯ä»¥çœ‹å‡º pinia çš„è®¢é˜…å“åº”å¼ä¸»è¦æ˜¯ä¾èµ– vue çš„ watch
    watch(
      () => pinia.state.value[$id] as UnwrapRef<S>,
      (state) => {
        if (options.flush === 'sync' ? isSyncListening : isListening) {
          callback(
            {
              storeId: $id,
              type: MutationType.direct,
              events: debuggerEvents as DebuggerEvent,
            },
            state
          )
        }
      },
      assign({}, $subscribeOptions, options)
    )
  )!

  return removeSubscription
}
```

å…¶ä¸­ï¼Œ `addSubscription` å‡½æ•°å¯ä»¥æŸ¥çœ‹[2. $onAction](%E6%B7%B1%E5%85%A5%20Pinia%EF%BC%9A%E4%BB%8E%E4%BB%A3%E7%A0%81%E5%87%BA%E5%8F%91%E6%8E%A2%E7%B4%A2%20Vue%20%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E7%9A%84%E5%A5%A5%E7%A7%98%2061ea2eb2bd234731b794df4b16ab9b7d.md) ã€‚

## 6. $dispose

åœæ­¢ store çš„ç›¸å…³ä½œç”¨åŸŸï¼Œå¹¶ä» store æ³¨å†Œè¡¨ä¸­åˆ é™¤å®ƒã€‚ æ’ä»¶å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æ¥æ¸…ç†å·²æ·»åŠ çš„ä»»ä½•å‰¯ä½œç”¨å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œ devtools æ’ä»¶åœæ­¢æ˜¾ç¤ºæ¥è‡ª devtools çš„å·²åœæ­¢çš„ storeã€‚

```tsx showLineNumbers
/**
 * $dispose
 * åœæ­¢ store çš„ç›¸å…³ä½œç”¨åŸŸï¼Œå¹¶ä» store æ³¨å†Œè¡¨ä¸­åˆ é™¤å®ƒã€‚
 * æ’ä»¶å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æ¥æ¸…ç†å·²æ·»åŠ çš„ä»»ä½•å‰¯ä½œç”¨å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œ devtools æ’ä»¶åœæ­¢æ˜¾ç¤ºæ¥è‡ª devtools çš„å·²åœæ­¢çš„ storeã€‚
 */
function $dispose() {
  scope.stop()
  subscriptions = []
  actionSubscriptions = []
  pinia._s.delete($id)
}
```

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_3](https://github.com/mk965/read-pinia/tree/article_3)

</aside>

---

# å…­ã€ğŸ§æºç åˆ†æï¼ˆ5ï¼‰â€”â€” è¾…åŠ©å‡½æ•°

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_4](https://github.com/mk965/read-pinia/tree/article_4)

</aside>

Pinia ä¹Ÿæä¾›äº†ä¸€ç»„ç±»ä¼¼ Vuex çš„Â **[æ˜ å°„ state çš„è¾…åŠ©å‡½æ•°](https://vuex.vuejs.org/zh/guide/state.html#mapstate-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0)**ã€‚ä½ å¯ä»¥ç”¨å’Œä¹‹å‰ä¸€æ ·çš„æ–¹å¼æ¥å®šä¹‰ Storeã€‚è¿™é‡Œä¸åšä½¿ç”¨çš„ä»‹ç»ï¼Œç”¨æ³•è¯·çœ‹å®˜ç½‘ï¼š[https://pinia.vuejs.org/zh/introduction.html](https://pinia.vuejs.org/zh/introduction.html)

ğŸšªæºç ç›®å½•ï¼š `src/pinia/mapHelpers.ts`

## 1. mapActions

`mapActions` æœ‰ä¸¤ç§ä¼ å‚æ–¹å¼ï¼Œä¸¤ç§ä¼ å‚æ–¹å¼ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ `defineStore` ä¸­è¿”å›çš„ `useStore` å‡½æ•°ã€‚

- ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œkey ä¸ºæ˜ å°„åˆ° `methods` ä¸­çš„åå­—ï¼Œvalue ä¸º action çš„åå­—ã€‚
- ä¼ å…¥ä¸€ä¸ªæ•°ç»„ï¼Œitem ä¸º action çš„åå­—ã€‚

ä¸‹é¢æ˜¯ `mapActions` çš„æºç ï¼Œä¸»è¦æ€æƒ³å°±æ˜¯è°ƒç”¨ `useStore` æ–¹æ³•å¾—åˆ° Store ï¼Œç„¶åå–å‡ºéœ€è¦çš„ action å¹¶è¿”å›ã€‚

````tsx showLineNumbers
/**
 * è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ å…¥ useStore å’Œä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åœ¨å¯¼å…¥è¿‡ç¨‹ä¸­ç»™ action æ”¹åï¼Œå¯¹è±¡ key ä¸º action çš„æ–°åå­—ï¼Œvalue ä¸º action çš„æ—§åå­—
 * é€šè¿‡ç”Ÿæˆä¸€ä¸ªä¼ é€’åˆ°ç»„ä»¶çš„ methods å­—æ®µçš„å¯¹è±¡ï¼Œ å…è®¸ç›´æ¥ä½¿ç”¨ store çš„ actionï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ç»„åˆå¼ API(setup())ã€‚ è¯¥å¯¹è±¡çš„å€¼æ˜¯ actionï¼Œ è€Œé”®æ˜¯äº§ç”Ÿçš„æ–¹æ³•åç§°ã€‚
 *
 * @example
 * ```js showLineNumbers
 * export default {
 *   methods: {
 *     // other methods properties
 *     // useCounterStore has two actions named `increment` and `setCount`
 *     ...mapActions(useCounterStore, { moar: 'increment', setIt: 'setCount' })
 *   },
 *
 *   created() {
 *     this.moar()
 *     this.setIt(2)
 *   }
 * }
 * ```
 *
 * @param useStore - defineStore è¿”å›çš„ useStore
 * @param keyMapper - ä¸º action å®šä¹‰æ–°åç§°çš„å¯¹è±¡
 */
export function mapActions<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  KeyMapper extends Record<string, keyof A>,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keyMapper: KeyMapper
): _MapActionsObjectReturn<A, KeyMapper>
/**
 * è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ å…¥ useStore å’Œä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„å†…å®¹ä¸ºéœ€è¦å¯¼å…¥çš„ action åç§°
 * é€šè¿‡ç”Ÿæˆä¸€ä¸ªä¼ é€’åˆ°ç»„ä»¶çš„ methods å­—æ®µçš„å¯¹è±¡ï¼Œ å…è®¸ç›´æ¥ä½¿ç”¨ store çš„ actionï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ç»„åˆå¼ API(setup())ã€‚ è¯¥å¯¹è±¡çš„å€¼æ˜¯ actionï¼Œ è€Œé”®æ˜¯äº§ç”Ÿçš„æ–¹æ³•åç§°ã€‚
 *
 * @example
 * ```js showLineNumbers
 * export default {
 *   methods: {
 *     // other methods properties
 *     ...mapActions(useCounterStore, ['increment', 'setCount'])
 *   },
 *
 *   created() {
 *     this.increment()
 *     this.setCount(2) // pass arguments as usual
 *   }
 * }
 * ```
 *
 * @param useStore - defineStore è¿”å›çš„ useStore
 * @param keys - è¦æ˜ å°„çš„ action åç§°æ•°ç»„
 */
export function mapActions<Id extends string, S extends StateTree, G extends _GettersTree<S>, A>(
  useStore: StoreDefinition<Id, S, G, A>,
  keys: Array<keyof A>
): _MapActionsReturn<A>
/**
 * é€šè¿‡ç”Ÿæˆä¸€ä¸ªä¼ é€’åˆ°ç»„ä»¶çš„ methods å­—æ®µçš„å¯¹è±¡ï¼Œ å…è®¸ç›´æ¥ä½¿ç”¨ store çš„ actionï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ç»„åˆå¼ API(setup())ã€‚ è¯¥å¯¹è±¡çš„å€¼æ˜¯ actionï¼Œ è€Œé”®æ˜¯äº§ç”Ÿçš„æ–¹æ³•åç§°ã€‚
 *
 * @param useStore - defineStore è¿”å›çš„ useStore
 * @param keysOrMapper - array or object
 */
export function mapActions<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  KeyMapper extends Record<string, keyof A>,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keysOrMapper: Array<keyof A> | KeyMapper
): _MapActionsReturn<A> | _MapActionsObjectReturn<A, KeyMapper> {
  return Array.isArray(keysOrMapper)
    ? // å¦‚æœä¼ å…¥çš„æ˜¯æ•°ç»„ï¼Œéå†è¿™ä¸ªæ•°ç»„å–å‡ºæ‰€æœ‰ action åç§°
      keysOrMapper.reduce((reduced, key) => {
        // @ts-expect-error
        reduced[key] = function (
          // å¦‚æœç»„ä»¶çš„å…·ä½“ç±»å‹æ— æ³•è·å¾—ï¼Œæˆ–è€…ä½ å¹¶ä¸å…³å¿ƒç»„ä»¶çš„å…·ä½“ç±»å‹ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ ComponentPublicInstance
          this: ComponentPublicInstance,
          ...args: any[]
        ) {
          return useStore(this.$pinia)[key](...args)
        }
        return reduced
      }, {} as _MapActionsReturn<A>)
    : // å¦‚æœä¼ å…¥çš„æ˜¯å¯¹è±¡ï¼ŒkeysOrMapper[key] å€¼ä¸º action åç§°
      Object.keys(keysOrMapper).reduce(
        (reduced, key: keyof KeyMapper) => {
          // key ä¸ºæ–° name
          // @ts-expect-error
          reduced[key] = function (this: ComponentPublicInstance, ...args: any[]) {
            return useStore(this.$pinia)[keysOrMapper[key]](...args)
          }
          return reduced
        },
        {} as _MapActionsObjectReturn<A, KeyMapper>
      )
}
````

## 2. mapStores

é€šè¿‡ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œä¼ é€’åˆ°ç»„ä»¶çš„ `computed` å­—æ®µ ä»¥å…è®¸åœ¨ä¸ä½¿ç”¨ç»„åˆå¼ `API(setup())` çš„æƒ…å†µä¸‹ä½¿ç”¨ storeã€‚ å®ƒæ¥å—ä¸€ä¸ª store å®šä¹‰çš„åˆ—è¡¨å‚æ•°ã€‚

````tsx showLineNumbers
/**
 * é€šè¿‡ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œä¼ é€’åˆ°ç»„ä»¶çš„ computed å­—æ®µ ä»¥å…è®¸åœ¨ä¸ä½¿ç”¨ç»„åˆå¼ API(setup())çš„æƒ…å†µä¸‹ä½¿ç”¨ storeã€‚ å®ƒæ¥å—ä¸€ä¸ª store å®šä¹‰çš„åˆ—è¡¨å‚æ•°ã€‚
 *
 * @example
 * ```js showLineNumbers
 * export default {
 *   computed: {
 *     // other computed properties
 *     ...mapStores(useUserStore, useCartStore)
 *   },
 *
 *   created() {
 *     this.userStore // store with id "user"
 *     this.cartStore // store with id "cart"
 *   }
 * }
 * ```
 *
 * @param stores - è¦æ˜ å°„åˆ° object çš„ stores åˆ—è¡¨
 */
export function mapStores<Stores extends any[]>(
  // æ‰€æœ‰å‚æ•°æ”¾å…¥ stores æ•°ç»„ï¼Œæ‰€ä»¥ store ä¸éœ€è¦åœ¨åŒ…è£¹ä¸€å±‚æ•°ç»„
  ...stores: [...Stores]
): _Spread<Stores> {
  // ç›´æ¥å°† store é€šè¿‡å‚æ•°ä¼ é€’å³å¯ï¼Œä¸éœ€è¦æ”¾åˆ°æ•°ç»„ä¸­ï¼Œå¦‚æœæ”¾åˆ°äº†æ•°ç»„ä¸­å°±æŠ›å‡ºè­¦å‘Š
  if (__DEV__ && Array.isArray(stores[0])) {
    console.warn(
      `[ğŸ]: Directly pass all stores to "mapStores()" without putting them in an array:\n` +
        `Replace\n` +
        `\tmapStores([useAuthStore, useCartStore])\n` +
        `with\n` +
        `\tmapStores(useAuthStore, useCartStore)\n` +
        `This will fail in production if not fixed.`
    )
    stores = stores[0]
  }

  // éå†æ‰€æœ‰ä¼ è¿›æ¥çš„ useStore å¹¶æ‰§è¡Œï¼Œç„¶å return å‡ºå»å°±å¾—åˆ°äº†æ‰€æœ‰çš„ store
  return stores.reduce((reduced, useStore) => {
    // $id æ˜¯ defineStore æ·»åŠ çš„
    // @ts-expect-error: $id is added by defineStore
    reduced[useStore.$id + mapStoreSuffix] = function (this: ComponentPublicInstance) {
      return useStore(this.$pinia)
    }
    return reduced
  }, {} as _Spread<Stores>)
}
````

## 3. mapState

é€šè¿‡ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¼ é€’è‡³ç»„ä»¶çš„Â `computed`Â å­—æ®µï¼Œ ä»¥å…è®¸åœ¨ä¸ä½¿ç”¨ç»„åˆå¼ API(`setup()`)çš„æƒ…å†µä¸‹ä½¿ç”¨ä¸€ä¸ª store çš„ state å’Œ getterã€‚ è¯¥å¯¹è±¡çš„å€¼æ˜¯ state å±æ€§/getterï¼Œ è€Œé”®æ˜¯ç”Ÿæˆçš„è®¡ç®—å±æ€§åç§°ã€‚ ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¼ é€’ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ¥æ”¶ store ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ æ³¨æ„ï¼Œè™½ç„¶å®ƒå¯ä»¥é€šè¿‡Â `this` è®¿é—®ç»„ä»¶å®ä¾‹ï¼Œä½†å®ƒæ²¡æœ‰æ ‡æ³¨ç±»å‹ã€‚

````tsx showLineNumbers
/**
 * é€šè¿‡ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¼ é€’è‡³ç»„ä»¶çš„Â computedÂ å­—æ®µï¼Œ ä»¥å…è®¸åœ¨ä¸ä½¿ç”¨ç»„åˆå¼ API(setup())çš„æƒ…å†µä¸‹ä½¿ç”¨ä¸€ä¸ª store çš„ state å’Œ getterã€‚ è¯¥å¯¹è±¡çš„å€¼æ˜¯ state å±æ€§/getterï¼Œ è€Œé”®æ˜¯ç”Ÿæˆçš„è®¡ç®—å±æ€§åç§°ã€‚ ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¼ é€’ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ¥æ”¶ store ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ æ³¨æ„ï¼Œè™½ç„¶å®ƒå¯ä»¥é€šè¿‡Â this è®¿é—®ç»„ä»¶å®ä¾‹ï¼Œä½†å®ƒæ²¡æœ‰æ ‡æ³¨ç±»å‹ã€‚
 *
 * @example
 * ```js showLineNumbers
 * export default {
 *   computed: {
 *     // other computed properties
 *     // useCounterStore has a state property named `count` and a getter `double`
 *     ...mapState(useCounterStore, {
 *       n: 'count',
 *       triple: store => store.n * 3,
 *       // note we can't use an arrow function if we want to use `this`
 *       custom(store) {
 *         return this.someComponentValue + store.n
 *       },
 *       doubleN: 'double'
 *     })
 *   },
 *
 *   created() {
 *     this.n // 2
 *     this.doubleN // 4
 *   }
 * }
 * ```
 *
 * @param useStore - defineStore ä¸­è¿”å›çš„ useStore
 * @param keyMapper - state çš„å±æ€§å æˆ– getters çš„å¯¹è±¡
 */
export function mapState<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  KeyMapper extends Record<string, keyof S | keyof G | ((store: Store<Id, S, G, A>) => any)>,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keyMapper: KeyMapper
): _MapStateObjectReturn<Id, S, G, A, KeyMapper>

/**
 * Allows using state and getters from one store without using the composition
 * API (`setup()`) by generating an object to be spread in the `computed` field
 * of a component.
 *
 * @example
 * ```js showLineNumbers
 * export default {
 *   computed: {
 *     // other computed properties
 *     ...mapState(useCounterStore, ['count', 'double'])
 *   },
 *
 *   created() {
 *     this.count // 2
 *     this.double // 4
 *   }
 * }
 * ```
 *
 * @param useStore - defineStore ä¸­è¿”å›çš„ useStore
 * @param keys - state çš„å±æ€§å æˆ– getters çš„æ•°ç»„
 */
export function mapState<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  Keys extends keyof S | keyof G,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  // keyæ•°ç»„ï¼Œå†…å®¹ä»…é™äº State å’Œ Getter çš„ key
  keys: readonly Keys[]
): _MapStateReturn<S, G, Keys>

/**
 * Allows using state and getters from one store without using the composition
 * API (`setup()`) by generating an object to be spread in the `computed` field
 * of a component.
 *
 * @param useStore - defineStore ä¸­è¿”å›çš„ useStore
 * @param keysOrMapper - array or object
 */
export function mapState<Id extends string, S extends StateTree, G extends _GettersTree<S>, A>(
  useStore: StoreDefinition<Id, S, G, A>,
  keysOrMapper: any
): _MapStateReturn<S, G> | _MapStateObjectReturn<Id, S, G, A> {
  // æ­¤å¤„é€»è¾‘å’Œ mapAction å¾ˆåƒ
  return Array.isArray(keysOrMapper)
    ? keysOrMapper.reduce(
        (reduced, key) => {
          reduced[key] = function (this: ComponentPublicInstance) {
            // å’Œ mapAction çš„åŒºåˆ«ï¼šmapAction å–å‡ºçš„æ˜¯ç»è¿‡ wrapAction çš„ action ï¼Œç„¶ååœ¨è¿™è°ƒç”¨äº†ä¸€ä¸‹
            return useStore(this.$pinia)[key]
          } as () => any
          return reduced
        },
        {} as _MapStateReturn<S, G>
      )
    : Object.keys(keysOrMapper).reduce(
        (reduced, key: string) => {
          // @ts-expect-error
          reduced[key] = function (this: ComponentPublicInstance) {
            const store = useStore(this.$pinia)
            const storeKey = keysOrMapper[key]
            // ç”±äºæŸç§åŸå› ï¼ŒTS æ— æ³•å°† storeKey çš„ç±»å‹æ¨æ–­ä¸ºå‡½æ•°
            return typeof storeKey === 'function'
              ? (storeKey as (store: Store<Id, S, G, A>) => any).call(this, store)
              : store[storeKey]
          }
          return reduced
        },
        {} as _MapStateObjectReturn<Id, S, G, A>
      )
}
````

## 4. mapGetters

`mapGetters` å·²åºŸå¼ƒï¼Œç›´æ¥ä½¿ç”¨ `mapState` å³å¯ã€‚

```tsx showLineNumbers
/**
 * Alias for `mapState()`. You should use `mapState()` instead.
 * @deprecated use `mapState()` instead.
 */
export const mapGetters = mapState
```

## 5. mapWritableState

åœ¨ä½¿ç”¨ `$mapState` æŠŠ state å¯¼å…¥ `computed` æ—¶ï¼Œå¦‚æœç›´æ¥å»ä¿®æ”¹ state çš„å€¼æ˜¯ä¸å…è®¸çš„ã€‚

![pinia](/static/images/blog/202304/Pinia_source_code/img6.webp)

`$mapWritableState` **\*\*\*\***é™¤äº†åˆ›å»ºçš„è®¡ç®—å±æ€§çš„ setterï¼Œå…¶ä»–ä¸Â `mapState()`Â ç›¸åŒï¼Œ æ‰€ä»¥ state å¯ä»¥è¢«ä¿®æ”¹ã€‚ ä¸Â `mapState()`Â ä¸åŒçš„æ˜¯ï¼Œåªæœ‰Â `state`Â å±æ€§å¯ä»¥è¢«æ·»åŠ ã€‚

```tsx showLineNumbers
/**
 * é™¤äº†åˆ›å»ºçš„è®¡ç®—å±æ€§çš„ setterï¼Œå…¶ä»–ä¸ mapState() ç›¸åŒï¼Œ æ‰€ä»¥ state å¯ä»¥è¢«ä¿®æ”¹ã€‚ ä¸ mapState() ä¸åŒçš„æ˜¯ï¼Œåªæœ‰ state å±æ€§å¯ä»¥è¢«æ·»åŠ ã€‚
 *
 * @param useStore - store to map from
 * @param keyMapper - object of state properties
 */
export function mapWritableState<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  KeyMapper extends Record<string, keyof S>,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keyMapper: KeyMapper
): _MapWritableStateObjectReturn<S, KeyMapper>
/**
 * Allows using state and getters from one store without using the composition
 * API (`setup()`) by generating an object to be spread in the `computed` field
 * of a component.
 *
 * @param useStore - store to map from
 * @param keys - array of state properties
 */
export function mapWritableState<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  Keys extends keyof S,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keys: readonly Keys[]
): {
  [K in Keys]: {
    get: () => S[K]
    set: (value: S[K]) => any
  }
}
/**
 * Allows using state and getters from one store without using the composition
 * API (`setup()`) by generating an object to be spread in the `computed` field
 * of a component.
 *
 * @param useStore - store to map from
 * @param keysOrMapper - array or object
 */
export function mapWritableState<
  Id extends string,
  S extends StateTree,
  G extends _GettersTree<S>,
  A,
  KeyMapper extends Record<string, keyof S>,
>(
  useStore: StoreDefinition<Id, S, G, A>,
  keysOrMapper: Array<keyof S> | KeyMapper
): _MapWritableStateReturn<S> | _MapWritableStateObjectReturn<S, KeyMapper> {
  // ä¹Ÿæ˜¯å¯¹äºæ•°ç»„å’Œå¯¹è±¡çš„åˆ†åˆ«å¤„ç†
  // è¿”å›åŒ…å« get å’Œ set å‡½æ•°çš„å¯¹è±¡ï¼Œäº¤ç»™ computed å¤„ç†
  return Array.isArray(keysOrMapper)
    ? keysOrMapper.reduce((reduced, key) => {
        // @ts-ignore
        reduced[key] = {
          get(this: ComponentPublicInstance) {
            return useStore(this.$pinia)[key]
          },
          set(this: ComponentPublicInstance, value) {
            // it's easier to type it here as any
            return (useStore(this.$pinia)[key] = value as any)
          },
        }
        return reduced
      }, {} as _MapWritableStateReturn<S>)
    : Object.keys(keysOrMapper).reduce(
        (reduced, key: keyof KeyMapper) => {
          // @ts-ignore
          reduced[key] = {
            get(this: ComponentPublicInstance) {
              return useStore(this.$pinia)[keysOrMapper[key]]
            },
            set(this: ComponentPublicInstance, value) {
              // it's easier to type it here as any
              return (useStore(this.$pinia)[keysOrMapper[key]] = value as any)
            },
          }
          console.log(reduced)
          return reduced
        },
        {} as _MapWritableStateObjectReturn<S, KeyMapper>
      )
}
```

<aside>
ğŸ§‘ğŸ¼â€ğŸ’» æœ¬èŠ‚ä»£ç ï¼š[https://github.com/mk965/read-pinia/tree/article_4](https://github.com/mk965/read-pinia/tree/article_4)

</aside>

---

# âœ¨ç»“è¯­

ä»£ç è™½ç„¶æ¯”è¾ƒå¤šï¼Œä½†æ ¸å¿ƒé€»è¾‘è¿˜æ˜¯å€ŸåŠ© vue çš„ ref å’Œ reactive å®ç°å“åº”å¼ã€‚æŠŠ `state` å¤„ç†ä¸º `ref` ï¼ŒæŠŠ `getters` å¤„ç†æˆ `computed` ï¼Œæä¾›ä¸€äº›åŸºç¡€æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨å•ä¾‹æ¨¡å¼è¿”å›ä¸€ä¸ªå®ä¾‹ã€‚

å®Œæ•´æ³¨é‡Šä»£ç ï¼š

<aside>
ğŸ é¡¹ç›®åœ°å€ï¼š[https://github.com/mk965/read-pinia](https://github.com/mk965/read-pinia)

</aside>
