---
title: 'Vue æ•°æ®å“åº”å¼åŸç†'
date: '2021-02-22'
tags: ['FE', 'Vue']
draft: false
summary: 'Vue3 å¿«é€Ÿä¸Šæ‰‹æŒ‡å—ï½'
images: ['/static/images/blog/202009/Try_the_Vue3_combination_API/vue3.webp']
authors: ['default']
---

## ä¸€ã€VUE2ä¸­çš„å®ç°æ–¹æ³•

### 1. å‰è¨€

æˆ‘ä»¬çŸ¥é“ï¼šæ•°æ®é©±åŠ¨è§†å›¾çš„å…³é”®ç‚¹åˆ™åœ¨äºæˆ‘ä»¬å¦‚ä½•çŸ¥é“æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œåªè¦çŸ¥é“æ•°æ®åœ¨ä»€ä¹ˆæ—¶å€™å˜äº†ï¼Œé‚£ä¹ˆé—®é¢˜å°±å˜å¾—è¿åˆƒè€Œè§£ï¼Œæˆ‘ä»¬åªéœ€åœ¨æ•°æ®å˜åŒ–çš„æ—¶å€™å»é€šçŸ¥è§†å›¾æ›´æ–°å³å¯ã€‚

è¦æƒ³çŸ¥é“æ•°æ®ä»€ä¹ˆæ—¶å€™è¢«è¯»å–äº†æˆ–æ•°æ®ä»€ä¹ˆæ—¶å€™è¢«æ”¹å†™äº†ï¼Œå…¶å®ä¸éš¾ï¼Œ`JS`ä¸ºæˆ‘ä»¬æä¾›äº†`Object.defineProperty`æ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥è½»æ¾çš„çŸ¥é“æ•°æ®åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿå˜åŒ–ã€‚

### 2. Object.definePropety

ES5 æä¾›äº† `Object.defineProperty` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚

**è¯­æ³•ï¼š**

```js showLineNumbers
Object.defineProperty(obj, prop, descriptor)
```

1. **obj:** `è¦åœ¨å…¶ä¸Šå®šä¹‰å±æ€§çš„å¯¹è±¡ã€‚`
2. **prop:** `è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°ã€‚`
3. **descriptor:** `å°†è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„æè¿°ç¬¦ã€‚`

**ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š**

```js showLineNumbers
const object1 = {}

Object.defineProperty(object1, 'property1', {
  value: 42,
  writable: false,
})

object1.property1 = 77
// throws an error in strict mode

console.log(object1.property1)
// expected output: 42
```

**æè¿°ç¬¦ï¼š**

å¯¹è±¡é‡Œç›®å‰å­˜åœ¨çš„å±æ€§æè¿°ç¬¦æœ‰ä¸¤ç§ä¸»è¦å½¢å¼ï¼šæ•°æ®æè¿°ç¬¦å’Œ å­˜å–æè¿°ç¬¦ ã€‚æ•°æ®æè¿°ç¬¦æ˜¯ä¸€ä¸ªå…·æœ‰å€¼çš„å±æ€§ï¼Œè¯¥å€¼å¯ä»¥æ˜¯å¯å†™çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸å¯å†™çš„ã€‚å­˜å–æè¿°ç¬¦æ˜¯ç”± getter å‡½æ•°å’Œ setter å‡½æ•°æ‰€æè¿°çš„å±æ€§ã€‚ä¸€ä¸ªæè¿°ç¬¦åªèƒ½æ˜¯è¿™ä¸¤è€…å…¶ä¸­ä¹‹ä¸€ï¼›ä¸èƒ½åŒæ—¶æ˜¯ä¸¤è€…ã€‚

è¿™ä¸¤ç§æè¿°ç¬¦éƒ½æ˜¯å¯¹è±¡ã€‚å®ƒä»¬å…±äº«ä»¥ä¸‹å¯é€‰é”®å€¼ï¼ˆé»˜è®¤å€¼æ˜¯æŒ‡åœ¨ä½¿ç”¨ Object.defineProperty() å®šä¹‰å±æ€§æ—¶çš„é»˜è®¤å€¼ï¼‰ï¼š

- `configurable`å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ `configurable` é”®å€¼ä¸º `true` æ—¶ï¼Œè¯¥å±æ€§çš„æè¿°ç¬¦æ‰èƒ½å¤Ÿè¢«æ”¹å˜ï¼ŒåŒæ—¶è¯¥å±æ€§ä¹Ÿèƒ½ä»å¯¹åº”çš„å¯¹è±¡ä¸Šè¢«åˆ é™¤ã€‚<br />**é»˜è®¤ä¸º** **`false`** ã€‚
- `enumerable`å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ `enumerable` é”®å€¼ä¸º `true` æ—¶ï¼Œè¯¥å±æ€§æ‰ä¼šå‡ºç°åœ¨å¯¹è±¡çš„æšä¸¾å±æ€§ä¸­ã€‚<br /> **é»˜è®¤ä¸º `false`** ã€‚æ•°æ®æè¿°ç¬¦è¿˜å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š
- `value`è¯¥å±æ€§å¯¹åº”çš„å€¼ã€‚å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ JavaScript å€¼ï¼ˆæ•°å€¼ï¼Œå¯¹è±¡ï¼Œå‡½æ•°ç­‰ï¼‰ã€‚<br /> **é»˜è®¤ä¸º [`undefined`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined)** ã€‚
- `writable`å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ `writable` é”®å€¼ä¸º `true` æ—¶ï¼Œå±æ€§çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ `value`ï¼Œæ‰èƒ½è¢«[`èµ‹å€¼è¿ç®—ç¬¦`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators#assignment_operators 'Currently only available in English (US)')æ”¹å˜ã€‚<br />**é»˜è®¤ä¸º `false`ã€‚**

å­˜å–æè¿°ç¬¦è¿˜å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š

- `get`å±æ€§çš„ getter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ getterï¼Œåˆ™ä¸º `undefined`ã€‚å½“è®¿é—®è¯¥å±æ€§æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚æ‰§è¡Œæ—¶ä¸ä¼ å…¥ä»»ä½•å‚æ•°ï¼Œä½†æ˜¯ä¼šä¼ å…¥ `this` å¯¹è±¡ï¼ˆç”±äºç»§æ‰¿å…³ç³»ï¼Œè¿™é‡Œçš„`this`å¹¶ä¸ä¸€å®šæ˜¯å®šä¹‰è¯¥å±æ€§çš„å¯¹è±¡ï¼‰ã€‚è¯¥å‡½æ•°çš„è¿”å›å€¼ä¼šè¢«ç”¨ä½œå±æ€§çš„å€¼ã€‚<br /> **é»˜è®¤ä¸º [`undefined`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined)** ã€‚
- `set`å±æ€§çš„ setter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ setterï¼Œåˆ™ä¸º `undefined`ã€‚å½“å±æ€§å€¼è¢«ä¿®æ”¹æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯è¢«èµ‹äºˆçš„æ–°å€¼ï¼‰ï¼Œä¼šä¼ å…¥èµ‹å€¼æ—¶çš„ `this` å¯¹è±¡ã€‚<br /> **é»˜è®¤ä¸º [`undefined`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined)** ã€‚

### 3. ä½¿ Object å˜å¾—å¯ä¾¦æµ‹

æ•°æ®çš„æ¯æ¬¡è¯»å’Œå†™èƒ½å¤Ÿè¢«æˆ‘ä»¬çœ‹çš„è§ï¼Œå³æˆ‘ä»¬èƒ½å¤ŸçŸ¥é“æ•°æ®ä»€ä¹ˆæ—¶å€™è¢«è¯»å–äº†æˆ–æ•°æ®ä»€ä¹ˆæ—¶å€™è¢«æ”¹å†™äº†ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºæ•°æ®å˜çš„â€˜å¯è§‚æµ‹â€™ã€‚

è¦å°†æ•°æ®å˜çš„â€˜å¯è§‚æµ‹â€™ï¼Œæˆ‘ä»¬å°±è¦å€ŸåŠ©å‰è¨€ä¸­æåˆ°çš„`Object.defineProperty`æ–¹æ³•äº†ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ä½¿æ•°æ®å˜å¾—â€œå¯è§‚æµ‹â€ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ•°æ®å¯¹è±¡`car`ï¼š

```js showLineNumbers
let car = {
  brand: 'BMW',
  price: 3000,
}
```

æˆ‘ä»¬å®šä¹‰äº†è¿™ä¸ª`car`çš„å“ç‰Œ`brand`æ˜¯`BMW`,ä»·æ ¼`price`æ˜¯3000ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡`car.brand`å’Œ`car.price`ç›´æ¥è¯»å†™è¿™ä¸ª`car`å¯¹åº”çš„å±æ€§å€¼ã€‚ä½†æ˜¯ï¼Œå½“è¿™ä¸ª`car`çš„å±æ€§è¢«è¯»å–æˆ–ä¿®æ”¹æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥æƒ…ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•åšæ‰èƒ½å¤Ÿè®©`car`ä¸»åŠ¨å‘Šè¯‰æˆ‘ä»¬ï¼Œå®ƒçš„å±æ€§è¢«ä¿®æ”¹äº†å‘¢ï¼Ÿ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨`Object.defineProperty()`æ”¹å†™ä¸Šé¢çš„ä¾‹å­ï¼š

```js showLineNumbers
let car = {}
let val = 3000
Object.defineProperty(car, 'price', {
  enumerable: true,
  configurable: true,
  get() {
    console.log('priceå±æ€§è¢«è¯»å–äº†')
    return val
  },
  set(newVal) {
    console.log('priceå±æ€§è¢«ä¿®æ”¹äº†')
    val = newVal
  },
})
```

é€šè¿‡`Object.defineProperty()`æ–¹æ³•ç»™`car`å®šä¹‰äº†ä¸€ä¸ª`price`å±æ€§ï¼Œå¹¶æŠŠè¿™ä¸ªå±æ€§çš„è¯»å’Œå†™åˆ†åˆ«ä½¿ç”¨`get()`å’Œ`set()`è¿›è¡Œæ‹¦æˆªï¼Œæ¯å½“è¯¥å±æ€§è¿›è¡Œè¯»æˆ–å†™æ“ä½œçš„æ—¶å€™å°±ä¼šè§¦å‘`get()`å’Œ`set()`ã€‚å¦‚ä¸‹å›¾ï¼š

![](/static/images/blog/202102/VUE_data_reactivity/img1.webp)

å¯ä»¥çœ‹åˆ°ï¼Œ`car`å·²ç»å¯ä»¥ä¸»åŠ¨å‘Šè¯‰æˆ‘ä»¬å®ƒçš„å±æ€§çš„è¯»å†™æƒ…å†µäº†ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œè¿™ä¸ª`car`çš„æ•°æ®å¯¹è±¡å·²ç»æ˜¯â€œå¯è§‚æµ‹â€çš„äº†ã€‚

ä¸ºäº†æŠŠ`car`çš„æ‰€æœ‰å±æ€§éƒ½å˜å¾—å¯è§‚æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š

```js showLineNumbers
// æºç ä½ç½®ï¼šsrc/core/observer/index.js

/**
 * Observerç±»ä¼šé€šè¿‡é€’å½’çš„æ–¹å¼æŠŠä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½è½¬åŒ–æˆå¯è§‚æµ‹å¯¹è±¡
 */
export class Observer {
  constructor (value) {
    this.value = value
    // ç»™valueæ–°å¢ä¸€ä¸ª__ob__å±æ€§ï¼Œå€¼ä¸ºè¯¥valueçš„Observerå®ä¾‹
    // ç›¸å½“äºä¸ºvalueæ‰“ä¸Šæ ‡è®°ï¼Œè¡¨ç¤ºå®ƒå·²ç»è¢«è½¬åŒ–æˆå“åº”å¼äº†ï¼Œé¿å…é‡å¤æ“ä½œ
    def(value,'__ob__',this)
    if (Array.isArray(value)) {
      // å½“value/ä¸ºæ•°ç»„æ—¶çš„é€»è¾‘
      // ...
    } else {
      this.walk(value)
    }
  }

  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }
}
/**
 * ä½¿ä¸€ä¸ªå¯¹è±¡è½¬åŒ–æˆå¯è§‚æµ‹å¯¹è±¡
 * @param { Object } obj å¯¹è±¡
 * @param { String } key å¯¹è±¡çš„key
 * @param { Any } val å¯¹è±¡çš„æŸä¸ªkeyçš„å€¼
 */
function defineReactive (obj,key,val) {
  // å¦‚æœåªä¼ äº†objå’Œkeyï¼Œé‚£ä¹ˆval = obj[key]
  if (arguments.length === 2) {
    val = obj[key]
  }
  if(typeof val === 'object'){
      new Observer(val)
  }
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get(){
      console.log(`${key}å±æ€§è¢«è¯»å–äº†`);
      return val;
    },
    set(newVal){
      if(val === newVal){
          return
      }
      console.log(`${key}å±æ€§è¢«ä¿®æ”¹äº†`);
      val = newVal;
    }4
  })
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†`observer`ç±»ï¼Œå®ƒç”¨æ¥å°†ä¸€ä¸ªæ­£å¸¸çš„`object`è½¬æ¢æˆå¯è§‚æµ‹çš„`object`ã€‚

å¹¶ä¸”ç»™`value`æ–°å¢ä¸€ä¸ª`__ob__`å±æ€§ï¼Œå€¼ä¸ºè¯¥`value`çš„`Observer`å®ä¾‹ã€‚è¿™ä¸ªæ“ä½œç›¸å½“äºä¸º`value`æ‰“ä¸Šæ ‡è®°ï¼Œè¡¨ç¤ºå®ƒå·²ç»è¢«è½¬åŒ–æˆå“åº”å¼äº†ï¼Œé¿å…é‡å¤æ“ä½œ

ç„¶ååˆ¤æ–­æ•°æ®çš„ç±»å‹ï¼Œåªæœ‰`object`ç±»å‹çš„æ•°æ®æ‰ä¼šè°ƒç”¨`walk`å°†æ¯ä¸€ä¸ªå±æ€§è½¬æ¢æˆ`getter/setter`çš„å½¢å¼æ¥ä¾¦æµ‹å˜åŒ–ã€‚ æœ€åï¼Œåœ¨`defineReactive`ä¸­å½“ä¼ å…¥çš„å±æ€§å€¼è¿˜æ˜¯ä¸€ä¸ª`object`æ—¶ä½¿ç”¨`new observerï¼ˆvalï¼‰`æ¥é€’å½’å­å±æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠ`obj`ä¸­çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬å­å±æ€§ï¼‰éƒ½è½¬æ¢æˆ`getter/seter`çš„å½¢å¼æ¥ä¾¦æµ‹å˜åŒ–ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æˆ‘ä»¬å°†ä¸€ä¸ª`object`ä¼ åˆ°`observer`ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ª`object`å°±ä¼šå˜æˆå¯è§‚æµ‹çš„ã€å“åº”å¼çš„`object`ã€‚

`observer`ç±»ä½äºæºç çš„`src/core/observer/index.js`ä¸­ã€‚

é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·å®šä¹‰`car`:

```js showLineNumbers
let car = new Observer({
  brand: 'BMW',
  price: 3000,
})
```

è¿™æ ·ï¼Œ`car`çš„ä¸¤ä¸ªå±æ€§éƒ½å˜å¾—å¯è§‚æµ‹äº†ã€‚

## äºŒã€VUE3ä¸­çš„å®ç°æ–¹æ³• - Proxy

### 1. æ¦‚è¿°

Proxy æ˜¯ ES6 ä¸ºäº†æ“ä½œå¯¹è±¡å¼•å…¥çš„ API ã€‚

Proxy å¯ä»¥å¯¹ç›®æ ‡å¯¹è±¡çš„è¯»å–ã€å‡½æ•°è°ƒç”¨ç­‰æ“ä½œè¿›è¡Œæ‹¦æˆªï¼Œç„¶åè¿›è¡Œæ“ä½œå¤„ç†ã€‚å®ƒä¸ç›´æ¥æ“ä½œå¯¹è±¡ï¼Œè€Œæ˜¯åƒä»£ç†æ¨¡å¼ï¼Œé€šè¿‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œåœ¨è¿›è¡Œè¿™äº›æ“ä½œæ—¶ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›éœ€è¦çš„é¢å¤–æ“ä½œã€‚

### 2. åŸºæœ¬ç”¨æ³•

ä¸€ä¸ª Proxy å¯¹è±¡ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š `target`ã€`handler` ã€‚åœ¨é€šè¿‡ `Proxy` æ„é€ å‡½æ•°ç”Ÿæˆå®ä¾‹å¯¹è±¡æ—¶ï¼Œéœ€è¦æä¾›è¿™ä¸¤ä¸ªå‚æ•°ã€‚ `target`å³ç›®æ ‡å¯¹è±¡ï¼Œ`handler`æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå£°æ˜äº†ä»£ç†`target` çš„æŒ‡å®šè¡Œä¸ºã€‚

```js showLineNumbers
let target = {
  name: 'Tom',
  age: 24,
}
let handler = {
  get: function (target, key) {
    console.log('getting ' + key)
    return target[key] // ä¸æ˜¯target.key
  },
  set: function (target, key, value) {
    console.log('setting ' + key)
    target[key] = value
  },
}
let proxy = new Proxy(target, handler)
proxy.name // å®é™…æ‰§è¡Œ handler.get
proxy.age = 25 // å®é™…æ‰§è¡Œ handler.set
// getting name
// setting age
// 25

// target å¯ä»¥ä¸ºç©ºå¯¹è±¡
let targetEpt = {}
let proxyEpt = new Proxy(targetEpt, handler)
// è°ƒç”¨ get æ–¹æ³•ï¼Œæ­¤æ—¶ç›®æ ‡å¯¹è±¡ä¸ºç©ºï¼Œæ²¡æœ‰ name å±æ€§
proxyEpt.name // getting name
// è°ƒç”¨ set æ–¹æ³•ï¼Œå‘ç›®æ ‡å¯¹è±¡ä¸­æ·»åŠ äº† name å±æ€§
proxyEpt.name = 'Tom'
// setting name
// "Tom"
// å†æ¬¡è°ƒç”¨ get ï¼Œæ­¤æ—¶å·²ç»å­˜åœ¨ name å±æ€§
proxyEpt.name
// getting name
// "Tom"

// é€šè¿‡æ„é€ å‡½æ•°æ–°å»ºå®ä¾‹æ—¶å…¶å®æ˜¯å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œäº†æµ…æ‹·è´ï¼Œå› æ­¤ç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡ä¼šäº’ç›¸
// å½±å“
targetEpt
// {name: "Tom"}

// handler å¯¹è±¡ä¹Ÿå¯ä»¥ä¸ºç©ºï¼Œç›¸å½“äºä¸è®¾ç½®æ‹¦æˆªæ“ä½œï¼Œç›´æ¥è®¿é—®ç›®æ ‡å¯¹è±¡
let targetEmpty = {}
let proxyEmpty = new Proxy(targetEmpty, {})
proxyEmpty.name = 'Tom'
targetEmpty // {name: "Tom"}
```

æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ `Proxy` æ¥å®ç°ä¸€ä¸ªæ•°æ®å“åº”å¼

```js showLineNumbers
<!DOCTYPE>
<html>
<body>
	<div id="app">
		<input type="text" id="ipt" oninput="inputHandle()" />
        	<input type="button" value="å¢åŠ " onclick="add()" />
	        <input type="button" value="å‡å°‘" onclick="reduce()" />
        <div id="count"></div>
    </div>
    <script type="text/javascript">
        const iptDom = document.getElementById("ipt");
        const countDom = document.getElementById("count");

        const tom = {
            name: "tom",
            age: 18
        }
        const proxy = new Proxy(tom, {
            get() {
                console.log("age è¢«è¯»å–");
                return tom.age;
            },
            set(obj, name, val) {
                console.log("age è¢«ä¿®æ”¹");
                obj[name] = val;
                iptDom.value = val;
                countDom.innerText = val;
            }
        });

        function add () {
            proxy.age++;
        }

        function reduce () {
            proxy.age--;
        }

        function inputHandle (e) {
            proxy.age = iptDom.value;
        }
    </script>
</body>
</html>
```

å½“ç„¶è¿™æ˜¯ç®€å•ç‰ˆçš„å“åº”å¼å®ç°ï¼Œå¦‚æœéœ€è¦å®ç°ä¸€ä¸ª Vue ä¸­çš„å“åº”å¼ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ get ä¸­æ”¶é›†ä¾èµ–ï¼Œåœ¨ set æ´¾å‘æ›´æ–°ï¼Œä¹‹æ‰€ä»¥ Vue3.0 è¦ä½¿ç”¨ Proxy æ›¿æ¢åŸæœ¬çš„ API åŸå› åœ¨äº Proxy æ— éœ€ä¸€å±‚å±‚é€’å½’ä¸ºæ¯ä¸ªå±æ€§æ·»åŠ ä»£ç†ï¼Œä¸€æ¬¡å³å¯å®Œæˆä»¥ä¸Šæ“ä½œï¼Œæ€§èƒ½ä¸Šæ›´å¥½ï¼Œå¹¶ä¸”åŸæœ¬çš„å®ç°æœ‰ä¸€äº›æ•°æ®æ›´æ–°ä¸èƒ½ç›‘å¬åˆ°ï¼Œä½†æ˜¯ Proxy å¯ä»¥å®Œç¾ç›‘å¬åˆ°ä»»ä½•æ–¹å¼çš„æ•°æ®æ”¹å˜ï¼Œå”¯ä¸€ç¼ºé™·å¯èƒ½å°±æ˜¯æµè§ˆå™¨çš„å…¼å®¹æ€§ä¸å¥½äº†ã€‚

æºç ï¼š

```js showLineNumbers
function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>,
  proxyMap: WeakMap<Target, any>
) {
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }
    return target
  }
  // target is already a Proxy, return it.
  // exception: calling readonly() on a reactive object
  if (
    target[ReactiveFlags.RAW] &&
    !(isReadonly && target[ReactiveFlags.IS_REACTIVE])
  ) {
    return target
  }
  // target already has corresponding Proxy
  const existingProxy = proxyMap.get(target)
  if (existingProxy) {
    return existingProxy
  }
  // only a whitelist of value types can be observed.
  const targetType = getTargetType(target)
  if (targetType === TargetType.INVALID) {
    return target
  }
  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
  )
  proxyMap.set(target, proxy)
  return proxy
}
```

### Proxyå®ç°ç®€ç‰ˆVue

```html showLineNumbers
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>æ ‡é¢˜</title>
  </head>
  <body>
    <div id="app">
      <input type="text" v-model="count" />
      <input type="button" value="å¢åŠ " @click="add" />
      <input type="button" value="å‡å°‘" @click="reduce" />
      <div v-bind="count"></div>
    </div>
    <script type="text/javascript">
      class Vue {
        constructor(options) {
          this.$el = document.querySelector(options.el)
          this.$methods = options.methods
          this._binding = {}
          this._observer(options.data)
          this._compile(this.$el)
        }
        _pushWatcher(watcher) {
          if (!this._binding[watcher.key]) {
            this._binding[watcher.key] = []
          }
          this._binding[watcher.key].push(watcher)
        }
        /*
           observerçš„ä½œç”¨æ˜¯èƒ½å¤Ÿå¯¹æ‰€æœ‰çš„æ•°æ®è¿›è¡Œç›‘å¬æ“ä½œï¼Œé€šè¿‡ä½¿ç”¨Proxyå¯¹è±¡
           ä¸­çš„setæ–¹æ³•æ¥ç›‘å¬ï¼Œå¦‚æœ‰å‘ç”Ÿå˜åŠ¨å°±ä¼šæ‹¿åˆ°æœ€æ–°å€¼é€šçŸ¥è®¢é˜…è€…ã€‚
          */
        _observer(datas) {
          const me = this
          const handler = {
            set(target, key, value) {
              const rets = Reflect.set(target, key, value)
              me._binding[key].map((item) => {
                item.update()
              })
              return rets
            },
          }
          this.$data = new Proxy(datas, handler)
        }
        /*
           æŒ‡ä»¤è§£æå™¨ï¼Œå¯¹æ¯ä¸ªå…ƒç´ èŠ‚ç‚¹çš„æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼Œæ ¹æ®æŒ‡ä»¤æ¨¡æ¿æ›¿æ¢æ•°æ®ï¼Œä»¥åŠç»‘å®šç›¸å¯¹åº”çš„æ›´æ–°å‡½æ•°
          */
        _compile(root) {
          const nodes = Array.prototype.slice.call(root.children)
          const data = this.$data
          nodes.map((node) => {
            if (node.children && node.children.length) {
              this._compile(node.children)
            }
            const $input = node.tagName.toLocaleUpperCase() === 'INPUT'
            const $textarea = node.tagName.toLocaleUpperCase() === 'TEXTAREA'
            const $vmodel = node.hasAttribute('v-model')
            // å¦‚æœæ˜¯inputæ¡† æˆ– textarea çš„è¯ï¼Œå¹¶ä¸”å¸¦æœ‰ v-model å±æ€§çš„
            if (($vmodel && $input) || ($vmodel && $textarea)) {
              const key = node.getAttribute('v-model')
              this._pushWatcher(new Watcher(node, 'value', data, key))
              node.addEventListener('input', () => {
                data[key] = node.value
              })
            }
            if (node.hasAttribute('v-bind')) {
              const key = node.getAttribute('v-bind')
              this._pushWatcher(new Watcher(node, 'innerHTML', data, key))
            }
            if (node.hasAttribute('@click')) {
              const methodName = node.getAttribute('@click')
              const method = this.$methods[methodName].bind(data)
              node.addEventListener('click', method)
            }
          })
        }
      }
      /*
         watcherçš„ä½œç”¨æ˜¯ é“¾æ¥Observer å’Œ Compileçš„æ¡¥æ¢ï¼Œèƒ½å¤Ÿè®¢é˜…å¹¶æ”¶åˆ°æ¯ä¸ªå±æ€§å˜åŠ¨çš„é€šçŸ¥ï¼Œ
         æ‰§è¡ŒæŒ‡ä»¤ç»‘å®šçš„å“åº”çš„å›è°ƒå‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ã€‚
        */
      class Watcher {
        constructor(node, attr, data, key) {
          this.node = node
          this.attr = attr
          this.data = data
          this.key = key
        }
        update() {
          this.node[this.attr] = this.data[this.key]
        }
      }
    </script>
    <script type="text/javascript">
      new Vue({
        el: '#app',
        data: {
          count: 0,
        },
        methods: {
          add() {
            this.count++
          },
          reduce() {
            this.count--
          },
        },
      })
    </script>
  </body>
</html>
```

## ç›¸å…³æ–‡æ¡£

1. Object.defineProperty MDNæ–‡æ¡£ï¼š[æ–‡æ¡£é“¾æ¥](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)
2. Proxy MDNæ–‡æ¡£ï¼š[æ–‡æ¡£é“¾æ¥](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy)
