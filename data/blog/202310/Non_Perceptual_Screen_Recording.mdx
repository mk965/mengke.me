---
title: 'ğŸ“· çº¯å‰ç«¯ä¹Ÿå¯ä»¥å®ç°ã€Œç”¨æˆ·æ— æ„ŸçŸ¥å½•å±ã€ï¼Ÿ'
date: '2023-10-25'
tags: ['Record Screen', 'html2Canvas', 'Canvas']
draft: false
summary: 'å¦‚æœçœŸæ­£åšåˆ°æ— æ„ŸçŸ¥ï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½å€ŸåŠ©æµè§ˆå™¨æˆ–è€…ç³»ç»Ÿç³»ç»Ÿçš„èƒ½åŠ›äº†ã€‚æˆ‘ä»¬èƒ½åšçš„å°±åªèƒ½æ˜¯é€šè¿‡jså»æ“ä½œäº†ã€‚è¦åœ¨é¡µé¢å†…ç›´æ¥å½•åˆ¶è§†é¢‘ä¼¼ä¹å¹¶ä¸å®¹æ˜“ï¼Œæ²¡æœ‰ç°æˆçš„å¼€æºåº“ä»¥ä½¿ç”¨ï¼Œä¹Ÿæ²¡æœ‰å¾ˆå¥½çš„æƒ³æ³•ã€‚é‚£æˆ‘ä»¬æ¢ä¸€ä¸ªæ€è·¯...'
images:
  [
    '/static/images/blog/202310/Non_Perceptual_Screen_Recording/andy-holmes-lZTQZRIXzDc-unsplash.webp',
  ]
authors: ['default']
---

## å‰è¨€

[æ˜é‡‘åœ°å€](https://juejin.cn/post/7293462197386592283)

è¦åœ¨ JavaScript ä¸­å®ç°å±å¹•å½•åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ `navigator.mediaDevices.getDisplayMedia()` æ–¹æ³•æ¥è·å–å±å¹•çš„åª’ä½“æµã€‚ç„¶åï¼Œå¯ä½¿ç”¨ `MediaRecorder` å¯¹è±¡å°†åª’ä½“æµå½•åˆ¶ä¸ºè§†é¢‘æ–‡ä»¶ã€‚

ä½†è¯¥æ–¹æ³•ä¼šåœ¨æµè§ˆå™¨å¼¹å‡ºä¸€ä¸ªæˆæƒçª—å£ï¼Œè®©ç”¨æˆ·é€‰æ‹©è¦åˆ†äº«çš„å†…å®¹ï¼Œè¿™ä¸å¯å®ç°â€œæ— æ„ŸçŸ¥â€ã€‚

![Authorization Prompt](/static/images/blog/202310/Non_Perceptual_Screen_Recording/authorization_prompt.webp)

å¦‚æœçœŸæ­£åšåˆ°æ— æ„ŸçŸ¥ï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½å€ŸåŠ©æµè§ˆå™¨æˆ–è€…ç³»ç»Ÿç³»ç»Ÿçš„èƒ½åŠ›äº†ã€‚æˆ‘ä»¬èƒ½åšçš„å°±åªèƒ½æ˜¯é€šè¿‡jså»æ“ä½œäº†ã€‚

è¦åœ¨é¡µé¢å†…ç›´æ¥å½•åˆ¶è§†é¢‘ä¼¼ä¹å¹¶ä¸å®¹æ˜“ï¼Œæ²¡æœ‰ç°æˆçš„å¼€æºåº“å¯ä»¥ä½¿ç”¨ï¼Œä¹Ÿæ²¡æœ‰å¾ˆå¥½çš„æƒ³æ³•ã€‚

é‚£æˆ‘ä»¬æ¢ä¸€ä¸ªæ€è·¯ï¼Œè§†é¢‘æ˜¯ç”±å¸§ç»„æˆçš„ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä¸æ–­çš„æˆªå›¾ï¼Œç„¶åç»„åˆæˆä¸€æ®µè§†é¢‘ï¼Ÿå¥½åƒæ˜¯å¯ä»¥çš„ã€‚

## æ•ˆæœ

[å»ã€Œç ä¸Šæ˜é‡‘ã€æŸ¥çœ‹](https://code.juejin.cn/pen/7293465912663867419)

## é¡µé¢

å…ˆå†™ä¸€ä¸ªç®€å•çš„é¡µé¢ï¼š

```html showLineNumbers
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Canvasè§†é¢‘å½•åˆ¶</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <main>
      <div class="buttons">
        <button class="start-btn">å¼€å§‹å½•åˆ¶</button>
        <button class="pause-btn">æš‚åœå½•åˆ¶</button>
        <button class="resume-btn">ç»§ç»­å½•åˆ¶</button>
        <button class="stop-btn">ç»“æŸå½•åˆ¶</button>
      </div>
      <div id="box">
        <section class="content">
          <h2>TODO LIST</h2>
          <div class="background-div">
            <button class="background-btn">åˆ‡æ¢èƒŒæ™¯é¢œè‰²</button>
          </div>
          <div id="todo-form">
            <input type="text" class="input-field" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹" />
            <button type="submit" class="submit-btn">æäº¤</button>
          </div>
          <div class="list"></div>
        </section>
      </div>
      <img src="" alt="" class="hidden" />
    </main>

    <script
      src="<https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js>"
      defer
    ></script>
    <script src="canvas.js" defer></script>
  </body>
</html>
```

## æˆªå›¾

å®ç°ç½‘é¡µçš„æˆªå›¾æ“ä½œï¼Œæœ€å¸¸ç”¨çš„åº“æ˜¯ `html2canvas`ç”¨ï¼Œå®ƒå¯ä»¥å°†ç½‘é¡µä¸­çš„ HTML å…ƒç´ è½¬æ¢ä¸º Canvas å…ƒç´ ï¼Œå¹¶å°†å…¶å¯¼å‡ºä¸ºå›¾åƒæ–‡ä»¶ã€‚åœ¨æµè§ˆå™¨ä¸­æ•è·æ•´ä¸ªé¡µé¢æˆ–ç‰¹å®šåŒºåŸŸçš„æˆªå›¾ï¼ŒåŒ…æ‹¬ CSS æ ·å¼å’Œæ¸²æŸ“æ•ˆæœã€‚

```js showLineNumbers
const canvasFunction = () => {
  html2canvas(box).then((canvas) => {
    const imgStr = canvas.toDataURL('image/png')
    img.src = imgStr
    img.onload = function () {
      ctx.drawImage(img, 0, 0, w, h)
    }
  })
}
```

## åˆæˆè§†é¢‘

è¿™é‡Œæˆ‘ä»¬è¦ä½¿ç”¨åˆ°ä¸€ä¸ª API `MediaRecorder` ï¼Œç”¨äºåœ¨æµè§ˆå™¨ä¸­è¿›è¡ŒéŸ³é¢‘å’Œè§†é¢‘çš„å½•åˆ¶ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æ•è·æ¥è‡ªéº¦å…‹é£ã€æ‘„åƒå¤´æˆ–å±å¹•çš„åª’ä½“æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºæ–‡ä»¶æˆ–è¿›è¡Œå®æ—¶æµä¼ è¾“ã€‚

å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼š

- `isTypeSupported()` è¿”å›ä¸€ä¸ª Boolean å€¼ï¼Œæ¥è¡¨ç¤ºè®¾ç½®çš„ MIME type æ˜¯å¦è¢«å½“å‰ç”¨æˆ·çš„è®¾å¤‡æ”¯æŒã€‚
- `start()` å¼€å§‹å½•åˆ¶åª’ä½“ï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨æ—¶å¯ä»¥é€šè¿‡ç»™ `timeslice` å‚æ•°è®¾ç½®ä¸€ä¸ªæ¯«ç§’å€¼ï¼Œå¦‚æœè®¾ç½®è¿™ä¸ªæ¯«ç§’å€¼ï¼Œé‚£ä¹ˆå½•åˆ¶çš„åª’ä½“ä¼šæŒ‰ç…§ä½ è®¾ç½®çš„å€¼è¿›è¡Œåˆ†å‰²æˆä¸€ä¸ªä¸ªå•ç‹¬çš„åŒºå—ï¼Œè€Œä¸æ˜¯ä»¥é»˜è®¤çš„æ–¹å¼å½•åˆ¶ä¸€ä¸ªéå¸¸å¤§çš„æ•´å—å†…å®¹ã€‚
- `pause()` æš‚åœåª’ä½“å½•åˆ¶ã€‚
- `resume()` ç»§ç»­å½•åˆ¶ä¹‹å‰è¢«æš‚åœçš„å½•åˆ¶åŠ¨ä½œã€‚
- `stop()` åœæ­¢å½•åˆ¶ã€‚åŒæ—¶è§¦å‘Â `dataavailable`Â äº‹ä»¶ï¼Œè¿”å›ä¸€ä¸ªå­˜å‚¨ `Blob` å†…å®¹çš„å½•åˆ¶æ•°æ®ã€‚ä¹‹åä¸å†è®°å½•ã€‚

é¦–å…ˆåˆ›å»ºä¸€ä¸ª `canvas` å…ƒç´ ï¼Œç”¨æ¥ä¿å­˜ `html2canvas` çš„æˆªå›¾ï¼Œç„¶åé€šè¿‡ `captureStream` æ–¹æ³•å®æ—¶æˆªå–åª’ä½“æµã€‚

```js showLineNumbers
const w = boxBoundingClientRect.width
const h = boxBoundingClientRect.height
const canvas = document.createElement('canvas')
canvas.setAttribute('id', 'canvas')
canvas.setAttribute('width', w)
canvas.setAttribute('height', h)
canvas.style.display = 'none'
box.appendChild(canvas)

const img = document.querySelector('img')
const ctx = canvas.getContext('2d')
const allChunks = []
const stream = canvas.captureStream(60) // 60 FPS recording   1ç§’60å¸§
```

é€šè¿‡ canvas çš„æµæ¥åˆ›å»ºä¸€ä¸ª `MediaRecorder` å®ä¾‹ï¼Œå¹¶åœ¨ `ondataavailable` äº‹ä»¶ä¸­ä¿å­˜è§†é¢‘ä¿¡æ¯ï¼š

```js showLineNumbers
const recorder = new MediaRecorder(stream, {
  mimeType: 'video/webm;codecs=vp9',
})

recorder.ondataavailable = (e) => {
  allChunks.push(e.data)
}
```

æœ€åï¼Œåœ¨åœæ­¢å½•åˆ¶æ—¶å°†å¸§ä¿¡æ¯åˆ›å»º blob å¹¶æ’å…¥åˆ°é¡µé¢ä¸Šï¼š

```js showLineNumbers
recorder.stop()
const fullBlob = new Blob(allChunks)
const videoUrl = window.URL.createObjectURL(fullBlob)

const video = document.createElement('video')
video.controls = true
video.src = videoUrl
video.muted = true
video.autoplay = true
document.body.appendChild(video)
```

æˆ–è€…å¯ä»¥å°†è§†é¢‘ä¸‹è½½

```js showLineNumbers
recorder.stop()
const fullBlob = new Blob(allChunks)
const videoUrl = window.URL.createObjectURL(fullBlob)

let link = document.createElement('a')
link.style.display = 'none'
let fullBlob = new Blob(allChunks)
let downloadUrl = window.URL.createObjectURL(fullBlob)
link.href = downloadUrl
link.download = 'canvas-video.mp4'
document.body.appendChild(link)
link.click()
link.remove()
```

è¿™é‡Œï¼Œä¸ºäº†èŠ‚çœèµ„æºï¼Œåªåœ¨ç‚¹å‡»æŒ‰é’®ã€è¾“å…¥ç­‰äº‹ä»¶å‘ç”Ÿæ—¶æ‰è°ƒç”¨ `html2canvas` æˆªå›¾ DOMã€‚

å¦‚æœå®æ—¶è®°å½•å±ä¹Ÿå¯ä»¥ä½¿ç”¨ `requestAnimationFrame` ã€‚

## æœ€å

è™½ç„¶å®ç°äº†æ— æ„ŸçŸ¥å½•åˆ¶å±å¹•ï¼Œä½†ä¹Ÿä»…é™äºç½‘é¡µå†…ï¼Œæ²¡æœ‰åŠæ³•å½•åˆ¶ç½‘é¡µä»¥å¤–çš„éƒ¨åˆ†ã€‚

ä»¥ä¸Šçš„ demo ä¸­åªå®ç°äº† DOM çš„å½•åˆ¶ï¼Œå¦‚æœæƒ³è¦å½•åˆ¶é¼ æ ‡è½¨è¿¹ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªè·Ÿéšé¼ æ ‡çš„å…ƒç´ ï½

ï¼ˆå®Œï¼‰
